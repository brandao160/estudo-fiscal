<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estudo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #252525;
            --hover-bg: #333333;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #3f3f3f;
            --accent-color: #3b82f6; /* Azul moderno */
            --accent-hover: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --tag-spec-bg: rgba(59, 130, 246, 0.2);
            --tag-spec-text: #93c5fd;
            --tag-basic-bg: rgba(245, 158, 11, 0.2);
            --tag-basic-text: #fcd34d;
        }

        /* --- STICKY TIMER BAR --- */
        #active-study-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border-top: 1px solid #444;
            display: none; /* Flex when active */
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 2000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            font-family: 'Segoe UI', sans-serif;
        }

        #active-study-bar.visible {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .bar-subject-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bar-subject-name {
            font-size: 1.4rem;
            font-weight: 800;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'Arial Black', sans-serif;
        }

        .bar-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-left: 20px;
        }

        .bar-timer i {
            font-size: 1.2rem;
            color: #aaa;
        }

        .bar-controls {
            display: flex;
            gap: 10px;
        }

        .bar-btn {
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .btn-continue {
            background: #2980b9;
            color: white;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .btn-continue:hover { background: #3498db; }

        .btn-save {
            background: #27ae60;
            color: white;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        }
        .btn-save:hover { background: #2ecc71; }

        .btn-cancel {
            background: #eee;
            color: #333;
        }
        .btn-cancel:hover { background: #fff; }

        /* --- NOTE MODAL --- */
        #note-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2100;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        #note-modal.open {
            display: flex;
        }

        .note-modal-content {
            background: #fff;
            color: #333;
            width: 600px;
            border-radius: 6px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            animation: zoomIn 0.2s ease-out;
        }

        .note-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #444;
        }

        .note-body {
            padding: 25px;
        }
        
        .note-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
        }

        .note-textarea {
            width: 100%;
            height: 150px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            font-family: inherit;
            resize: vertical;
            font-size: 1.1rem;
            color: #333;
            background: #fafafa;
        }
        
        .note-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .note-footer {
            padding: 15px 25px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* --- HISTORY VIEW --- */
        .history-day-group {
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .history-day-header {
            padding: 15px 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-date {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .history-total-time {
            background: #76b900;
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .history-item {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: background 0.2s;
        }
        .history-item:last-child { border-bottom: none; }
        .history-item:hover { background: rgba(255,255,255,0.02); }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-subject {
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            text-transform: uppercase;
        }

        .history-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .history-times {
            display: flex;
            gap: 15px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .history-note {
            font-style: italic;
            color: #aaa;
            font-size: 0.95rem;
            line-height: 1.5;
            padding-left: 22px; /* align with text */
            margin-top: 5px;
        }

        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--bg-color);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            padding-bottom: 40px; /* Extra padding for bottom scroll */
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-shrink: 0;
            overflow-y: auto; /* Allow scrolling if content is too tall */
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .brand i { color: var(--accent-color); }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .nav-item {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-item:hover {
            background-color: var(--hover-bg);
            color: #fff;
        }

        .nav-item.active {
            background-color: var(--accent-color);
            color: #fff;
        }

        .stats-container {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mini-stat {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .mini-stat-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .mini-stat-value { font-size: 1.2rem; font-weight: 700; color: #fff; }

        .progress-circle {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: var(--success-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        .top-bar {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-color);
        }

        .page-title h1 { margin: 0; font-size: 1.5rem; }
        .page-title p { margin: 5px 0 0 0; color: var(--text-muted); font-size: 0.9rem; }

        .content-area {
            flex: 1;
            overflow: auto;
            padding: 30px;
            position: relative;
        }

        /* Views (Tabs) */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Calendar View */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-controls button {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

        .calendar-controls button:hover { background: var(--hover-bg); }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .week-day {
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
            padding: 10px;
        }

        .day-cell {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-height: 100px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .day-cell:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .day-cell.empty { background: transparent; border: none; cursor: default; }
        .day-cell.today { border: 2px solid var(--accent-color); }

        .day-number {
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .day-dots {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
        }
        .dot.done { background-color: var(--success-color); }
        .dot.not-started { background-color: var(--accent-color); }
        .dot.incomplete { background-color: var(--warning-color); }

        /* Subjects View */
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .subject-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .subject-title { font-weight: 700; font-size: 1.1rem; }
        .subject-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-spec { background: var(--tag-spec-bg); color: var(--tag-spec-text); }
        .badge-basic { background: var(--tag-basic-bg); color: var(--tag-basic-text); }
        .badge-w1 { background: rgba(16,185,129,0.2); color: var(--success-color); }
        .badge-w2 { background: rgba(245,158,11,0.2); color: var(--warning-color); }
        .badge-w3 { background: rgba(239,68,68,0.2); color: var(--danger-color); }
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        .status-pill.ns { color: #93c5fd; background: rgba(59,130,246,0.15); }
        .status-pill.ic { color: var(--warning-color); background: rgba(245,158,11,0.15); }
        .status-pill.ok { color: var(--success-color); background: rgba(16,185,129,0.15); }

        .subject-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* List View */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-muted); font-weight: 500; }
        tr:hover { background-color: var(--hover-bg); }
        
        .status-select {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--card-bg);
            width: 800px;
            max-width: 95%;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title { font-size: 1.5rem; font-weight: 700; }
        .close-modal { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background-color: var(--sidebar-bg);
            border-radius: 0 0 12px 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: #fff;
        }
        .btn-primary:hover { background-color: var(--accent-hover); }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .btn-secondary:hover { background-color: var(--hover-bg); }

        .task-item {
            background: var(--bg-color);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .task-info { flex: 1; }
        .task-name { font-weight: 700; font-size: 1.2rem; margin-bottom: 8px; }
        .task-meta { font-size: 0.95rem; color: var(--text-muted); }

        .task-status-select {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            min-width: 180px;
            font-weight: 500;
        }
        
        /* ... existing focus styles ... */

        .task-observation {
            width: 100%;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 15px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: white;
        }

        /* Syllabus Tab Styles */
        .syllabus-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .syllabus-category {
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .syllabus-header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .syllabus-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .syllabus-title-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .syllabus-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .syllabus-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .syllabus-content {
            display: none;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
        }

        .syllabus-content.open {
            display: block;
        }

        .topic-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .topic-item:last-child {
            border-bottom: none;
        }

        .topic-checkbox {
            margin-top: 4px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--accent-color);
        }

        .topic-text {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .topic-checkbox:checked + .topic-text {
            color: var(--success-color);
            text-decoration: line-through;
            opacity: 0.7;
        }

        .progress-mini {
            width: 100px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-mini-fill {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s ease;
        }

        .meta-chip {
            display: flex;
            align-items: center;
            background: #1f1f1f;
            border: 1px solid #444;
            border-radius: 999px;
            padding: 4px 8px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .meta-chip .divider { width: 1px; height: 18px; background: #444; margin: 0 6px; }
        .step-btn {
            background: #2a2a2a;
            color: #ddd;
            border: 1px solid #444;
            border-radius: 999px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 700;
        }
        .step-btn:hover { background: #333; color: #fff; border-color: #555; }
        .chip-seg { display: flex; align-items: center; gap: 6px; color: #bbb; font-size: 0.8rem; }
        .chip-seg b { color: #fff; font-size: 0.9rem; }
        .preset-group { display: flex; gap: 6px; margin-left: 8px; }
        .preset-btn {
            background: rgba(59,130,246,0.15);
            color: #93c5fd;
            border: 1px solid #2d5db3;
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .preset-btn:hover { background: rgba(59,130,246,0.25); }

        .start-btn {
            background: var(--accent-color);
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
        }
        .start-btn i { margin-right: 6px; }

        .status-chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .status-chip {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: #1f1f1f;
            color: #ddd;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .status-chip.active { box-shadow: 0 0 0 2px rgba(59,130,246,0.35) inset; }
        .chip-todo { color: #bbb; }
        .chip-studying { color: #93c5fd; border-color: #2d5db3; }
        .chip-done { color: #34d399; border-color: #2b6f54; }
        .chip-skipped { color: #f59e0b; border-color: #8a5b0b; }

    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="brand">
            <i class="fas fa-book-reader"></i>
            <span>Painel de Estudos</span>
        </div>

        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('calendar')">
                <i class="fas fa-calendar-alt"></i>
                <span>Calend√°rio</span>
            </div>
            <div class="nav-item" onclick="switchTab('subjects')">
                <i class="fas fa-chart-pie"></i>
                <span>Mat√©rias & Progresso</span>
            </div>
            <div class="nav-item" onclick="switchTab('list')">
                <i class="fas fa-list"></i>
                <span>Lista Completa</span>
            </div>
            <div class="nav-item" onclick="switchTab('syllabus')">
                <i class="fas fa-clipboard-list"></i>
                <span>Conte√∫do Program√°tico</span>
            </div>
            <div class="nav-item" onclick="switchTab('time-stats')">
                <i class="fas fa-chart-pie"></i>
                <span>Tempo de Estudo</span>
            </div>
            <div class="nav-item" onclick="switchTab('history')">
                <i class="fas fa-history"></i>
                <span>Hist√≥rico</span>
            </div>
        </div>

        <div class="stats-container">
            <div class="mini-stat">
                <div class="mini-stat-label">Dias at√© a Prova</div>
                <div class="mini-stat-value" id="days-left-stat">0</div>
            </div>
            
            <div class="mini-stat">
                <div class="mini-stat-label">Progresso Geral</div>
                <div class="mini-stat-value" id="total-progress-stat">0%</div>
                <div class="progress-circle">
                    <div class="progress-fill" id="total-progress-bar"></div>
                </div>
            </div>

            <div class="mini-stat">
                <div class="mini-stat-label">Sequ√™ncia Atual üî•</div>
                <div class="mini-stat-value" id="streak-stat">0 dias</div>
            </div>

            <!-- Backup & Config -->
            <div style="margin-top: 20px; padding: 0 15px;">
                <button id="generate-cycle-button" onclick="generateCycleFromModel()" style="width: 100%; padding: 10px; background: var(--accent-color); border: none; color: #fff; border-radius: 6px; cursor: pointer; margin-bottom: 8px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700;">
                    <i class="fas fa-play-circle"></i> Gerar Ciclo de Estudo
                </button>
                
            <div style="margin-top: 10px; display: grid; gap: 8px;">
                <button id="btn-download-xlsx" onclick="downloadModelTemplateXLSX()" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-table"></i> Baixar Modelo Excel
                </button>
                <button id="btn-export-xlsx" onclick="exportCurrentModelXLSX()" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-file-export"></i> Exportar Modelo Atual (Excel)
                </button>
                <button id="btn-import-xlsx" onclick="triggerImportModelXLSX()" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-file-import"></i> Importar Modelo Excel
                </button>
                <input type="file" id="import-model-xlsx-input" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none" onchange="importModelXLSX(this)">
                </div>
                
                <div style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                     <button onclick="resetSchedule()" style="width: 100%; padding: 6px; background: transparent; border: 1px solid #ff6b6b; color: #ff6b6b; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                        <i class="fas fa-sync-alt"></i> Regerar Cronograma
                    </button>
                    <p style="font-size: 0.7rem; color: #666; margin-top: 5px; text-align: center;">Cuidado: Apaga progresso do calend√°rio.</p>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <div class="page-title">
                <h1 id="page-title-text">Calend√°rio de Estudos</h1>
                <p id="page-subtitle-text">Foco na meta: Ciclo de Estudo</p>
            </div>
            <div>
                <!-- User profile or settings could go here -->
            </div>
        </div>

        <div class="content-area">
            
            <!-- Tab: Calendar -->
            <div id="view-calendar" class="view-section active">
                <div class="calendar-header">
                    <h2 id="current-month-label" style="margin:0;">Dezembro 2025</h2>
                    <div class="calendar-controls">
                        <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="calendar-grid">
                    <div class="week-day">Seg</div>
                    <div class="week-day">Ter</div>
                    <div class="week-day">Qua</div>
                    <div class="week-day">Qui</div>
                    <div class="week-day">Sex</div>
                    <div class="week-day">S√°b</div>
                    <div class="week-day">Dom</div>
                </div>
                <div id="calendar-days" class="calendar-grid" style="margin-top: 10px;">
                    <!-- JS generated -->
                </div>
            </div>

            <!-- Tab: Subjects -->
            <div id="view-subjects" class="view-section">
                <div class="subjects-grid" id="subjects-container">
                    <!-- JS generated -->
                </div>
            </div>

            <!-- Tab: List -->
            <div id="view-list" class="view-section">
                <div id="list-filters" style="display:flex; gap:10px; align-items:flex-end; margin-bottom:10px;">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <label style="font-size:0.8rem; color: var(--text-muted);">Status</label>
                        <select id="filter-status" style="background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;">
                            <option value="">Todos</option>
                            <option value="pendente">Pendente</option>
                            <option value="feito">Feito</option>
                        </select>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <label style="font-size:0.8rem; color: var(--text-muted);">Mat√©ria</label>
                        <select id="filter-subject" style="background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;"></select>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <label style="font-size:0.8rem; color: var(--text-muted);">In√≠cio</label>
                        <input id="filter-start" type="date" style="background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;" />
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <label style="font-size:0.8rem; color: var(--text-muted);">Fim</label>
                        <input id="filter-end" type="date" style="background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;" />
                    </div>
                    <button onclick="clearListFilters()" style="margin-left:auto; background: transparent; border:1px solid var(--border-color); color:#fff; padding:6px 10px; border-radius:6px;">Limpar</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Data</th>
                            <th>Dia</th>
                            <th>Mat√©ria</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody id="list-tbody">
                        <!-- JS generated -->
                    </tbody>
                </table>
            </div>

            <!-- Tab: Syllabus -->
            <div id="view-syllabus" class="view-section">
                <div class="subject-card" style="margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0;">Conte√∫do Program√°tico - Estudo Fiscal</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">
                        Baseado no planejamento pessoal (2025/2026). Marque os t√≥picos conforme concluir o estudo.
                    </p>
                </div>
                <div id="syllabus-container" class="syllabus-container">
                    <!-- JS generated -->
                </div>
            </div>

            <!-- Tab: History -->
            <div id="view-history" class="view-section">
                <div id="history-container">
                    <!-- JS generated -->
                </div>
            </div>

            <!-- Tab: Time Stats -->
            <div id="view-time-stats" class="view-section">
                <div style="display: flex; gap: 30px; align-items: flex-start; flex-wrap: wrap;">
                    <div class="subject-card" style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 20px 0; text-align: center;">Distribui√ß√£o do Tempo</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="studyTimeChart"></canvas>
                        </div>
                    </div>
                    <div class="subject-card" style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 20px 0;">Tempo Total por Mat√©ria</h3>
                        <div id="time-stats-list" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- JS Generated -->
                        </div>
                    </div>
                    <div class="subject-card" style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 20px 0;">Contagem de PDF por Mat√©ria</h3>
                        <div id="pdf-stats-list" style="display: flex; flex-direction: column; gap: 10px;">
                            <!-- JS Generated -->
                        </div>
                    </div>
                    <div class="subject-card" style="flex: 1; min-width: 300px;">
                        <h3 style="margin: 0 0 10px 0;">Calibra√ß√£o do Ciclo</h3>
                        <div id="calibration-panel" style="display:flex; flex-direction:column; gap:10px;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <label style="width:120px; color: var(--text-muted);">Influ√™ncia T√≥picos (alpha)</label>
                                <input type="range" id="alpha-range" min="0" max="1" step="0.05" />
                                <input type="number" id="alpha-num" min="0" max="1" step="0.05" style="width:80px; background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;" />
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <label style="width:120px; color: var(--text-muted);">Curva Peso (beta)</label>
                                <input type="range" id="beta-range" min="0.5" max="2" step="0.05" />
                                <input type="number" id="beta-num" min="0.5" max="2" step="0.05" style="width:80px; background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;" />
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <label style="width:120px; color: var(--text-muted);">Curva T√≥picos (gamma)</label>
                                <input type="range" id="gamma-range" min="0" max="2" step="0.05" />
                                <input type="number" id="gamma-num" min="0" max="2" step="0.05" style="width:80px; background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;" />
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <label style="width:120px; color: var(--text-muted);">M√≠n/M√°x rep.</label>
                                <input type="number" id="minRep-num" min="1" max="20" step="1" style="width:80px; background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;" />
                                <input type="number" id="maxRep-num" min="1" max="20" step="1" style="width:80px; background:#1f2937; color:#fff; border:1px solid var(--border-color); padding:6px; border-radius:6px;" />
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <label style="width:120px; color: var(--text-muted);">Normalizar Semana</label>
                                <input type="checkbox" id="normalizeWeekly-check" />
                            </div>
                            <div>
                                <button onclick="saveCalibrationParams()" style="background: var(--accent-color); color:#fff; border:none; padding:6px 10px; border-radius:6px;">Aplicar</button>
                                <button onclick="renderCalibrationPreview()" style="background: transparent; border:1px solid var(--border-color); color:#fff; padding:6px 10px; border-radius:6px; margin-left:10px;">Preview</button>
                            </div>
                            <div id="calibration-preview" style="margin-top:10px; display:flex; flex-direction:column; gap:6px;"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal for Daily Tasks -->
    <div class="modal-overlay" id="day-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-date-title">Tarefas do Dia</div>
                <button class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="modal-task-list">
                <!-- Tasks go here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveModalChanges()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- NOTE MODAL -->
    <div id="note-modal">
        <div class="note-modal-content">
            <div class="note-header">
                <span>Como foi, Estudante? Lembre-se de anotar em que p√°gina parou do PDF/V√≠deo Aula</span>
                <button onclick="cancelNote()" style="background:none; border:none; color:#aaa; cursor:pointer; font-size:1.2rem;"><i class="fas fa-times"></i></button>
            </div>
            <div class="note-body">
                <label class="note-label">Anota√ß√µes</label>
                <textarea id="note-textarea" class="note-textarea" placeholder="Fa√ßa suas anota√ß√µes aqui!"></textarea>
            </div>
            <div class="note-footer">
                <button class="bar-btn btn-cancel" onclick="cancelNote()"><i class="fas fa-times"></i> Cancelar</button>
                <button class="bar-btn btn-save" onclick="saveNote()"><i class="fas fa-check"></i> Atualizar</button>
            </div>
        </div>
    </div>

    <!-- STICKY TIMER BAR -->
    <div id="active-study-bar">
        <div class="bar-subject-info">
            <div id="bar-subject-name" class="bar-subject-name">Subject Name</div>
            <div class="bar-timer">
                <i class="fas fa-stopwatch"></i>
                <span id="bar-timer-display">0h 0m 0s</span>
            </div>
        </div>
        <div class="bar-controls">
            <button id="btn-pause-resume" class="bar-btn btn-continue" onclick="togglePauseResume()">
                <i class="fas fa-pause"></i> Pausar
            </button>
            <button class="bar-btn btn-save" onclick="finishSession()">
                <i class="fas fa-check"></i> Salvar
            </button>
            <button class="bar-btn btn-cancel" onclick="cancelSession()">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        /**
         * Salva dados do localStorage em disco via API do servidor.
         */
        async function syncToDisk() {
            try {
                const payload = {
                    data: {
                        estudoFiscalData: JSON.parse(localStorage.getItem('estudoFiscalData') || '{}'),
                        estudoFiscalSyllabus: JSON.parse(localStorage.getItem('estudoFiscalSyllabus') || '{}'),
                        estudoFiscalStudyHistory: JSON.parse(localStorage.getItem('estudoFiscalStudyHistory') || '[]'),
                        estudoFiscalScheduleStructure: JSON.parse(localStorage.getItem('estudoFiscalScheduleStructure') || '[]'),
                        estudoFiscalModel: JSON.parse(localStorage.getItem('estudoFiscalModel') || 'null')
                    }
                };
                await fetch('/api/save_bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.warn('Falha ao sincronizar com disco:', e);
            }
        }

        /**
         * Envia uma linha de log para o servidor.
         */
        async function logEvent(message) {
            try {
                await fetch('/api/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
            } catch (e) {
                // Silencioso para n√£o interromper fluxo
            }
        }

        /**
         * Carrega dados do disco (se existirem) e injeta em localStorage.
         * Prioriza o ciclo persistido via /api/cycle.
         */
        async function hydrateFromDisk() {
            try {
                // 1) Tenta carregar ciclo dedicado
                const resCycle = await fetch('/api/cycle');
                const cycle = await resCycle.json();
                if (cycle && cycle.ok && cycle.schedule) {
                    localStorage.setItem('estudoFiscalScheduleStructure', JSON.stringify(cycle.schedule));
                    await logEvent(`HYDRATE: ciclo carregado (${Array.isArray(cycle.schedule) ? cycle.schedule.length : 0} dias)`);
                }

                // 2) Carrega demais dados
                const res = await fetch('/api/load_all');
                const json = await res.json();
                if (json && json.ok && json.data) {
                    const d = json.data;
                    if (d.estudoFiscalData) localStorage.setItem('estudoFiscalData', JSON.stringify(d.estudoFiscalData));
                    if (d.estudoFiscalSyllabus) localStorage.setItem('estudoFiscalSyllabus', JSON.stringify(d.estudoFiscalSyllabus));
                    if (d.estudoFiscalStudyHistory) localStorage.setItem('estudoFiscalStudyHistory', JSON.stringify(d.estudoFiscalStudyHistory));
                    // S√≥ usa backup do schedule se /api/cycle n√£o trouxe nada
                    if (!cycle.schedule && d.estudoFiscalScheduleStructure) {
                        localStorage.setItem('estudoFiscalScheduleStructure', JSON.stringify(d.estudoFiscalScheduleStructure));
                    }
                    if (d.estudoFiscalModel) localStorage.setItem('estudoFiscalModel', JSON.stringify(d.estudoFiscalModel));
                }
            } catch (e) {
                console.warn('Falha ao hidratar do disco:', e);
            }
        }
        let startDate = new Date('2025-12-16');
        let endDate = new Date('2026-12-31');
        
        let subjectsConfig = [
            // Conhecimentos B√°sicos (Peso 1)
            { name: "L√≠ngua Portuguesa", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Exatas", type: "B√°sico", weight: 1, tickets: 1 }, // Substitui RLM, Mat. Fin, Estat√≠stica
            { name: "Direito Constitucional", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Direito Administrativo", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Direito Financeiro", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Direito Civil", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Empresarial", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Penal", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Economia", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Contabilidade Geral", type: "B√°sico", weight: 1, tickets: 1 },
            { name: "Realidade do Estado", type: "B√°sico", weight: 1, tickets: 1 },
            
            // Conhecimentos Espec√≠ficos
            { name: "Tecnologia da Informa√ß√£o", type: "Espec√≠fico", weight: 2, tickets: 2 },
            { name: "Auditoria", type: "Espec√≠fico", weight: 3, tickets: 3 },
            { name: "Contabilidade Geral e Avan√ßada", type: "Espec√≠fico", weight: 3, tickets: 3 },
            { name: "Contabilidade P√∫blica", type: "Espec√≠fico", weight: 1, tickets: 1 },
            { name: "Contabilidade de Custos", type: "Espec√≠fico", weight: 3, tickets: 3 },
            { name: "Direito Tribut√°rio I", type: "Espec√≠fico", weight: 3, tickets: 3 },
            { name: "Direito Tribut√°rio II ‚Äì Reforma Tribut√°ria", type: "Espec√≠fico", weight: 3, tickets: 3 },
            { name: "Legisla√ß√£o Tribut√°ria Estadual", type: "Espec√≠fico", weight: 3, tickets: 3 }
        ];

        // Config padr√£o: mat√©rias por dia (Seg..Dom)
        let slotsPorDia = [5,5,5,5,5,8,8];

        // --- MODEL LOADER ---
        /**
         * Carrega um modelo salvo no localStorage e aplica em start/end/subjects.
         */
        function loadModelFromStorage() {
            const raw = localStorage.getItem('estudoFiscalModel');
            if (!raw) return;
            try {
                const model = JSON.parse(raw);
                if (model.inicioCiclo) startDate = new Date(model.inicioCiclo);
                if (model.fimCiclo) endDate = new Date(model.fimCiclo);
                if (Array.isArray(model.materias)) {
                    subjectsConfig = model.materias.map(m => ({
                        name: m.nome,
                        type: m.tipo || 'B√°sico',
                        weight: Number(m.peso || 1),
                        tickets: Number(m.tickets || 1),
                        qtdePdf: Number(m.qtdePdf || 0),
                        qtdePaginas: Number(m.qtdePaginas || 0)
                    }));
                }
                if (Array.isArray(model.slotsPorDia) && model.slotsPorDia.length === 7) {
                    slotsPorDia = model.slotsPorDia.map(n => Number(n) || 0);
                }
                if (model.concurso) {
                    const subEl = document.getElementById('page-subtitle-text');
                    if (subEl) subEl.textContent = `Foco na meta: ${model.concurso}`;
                }
                if (Array.isArray(model.syllabus)) {
                    syllabusData = model.syllabus; // ser√° definido abaixo como let
                }
                const savedScheduleJson = localStorage.getItem('estudoFiscalScheduleStructure');
                if (savedScheduleJson) {
                    setGenerateButtonState('success');
                    try {
                        const rawSchedule = JSON.parse(savedScheduleJson);
                        fullSchedule = rawSchedule.map(day => ({
                            ...day,
                            date: new Date(day.date),
                            tasks: day.tasks.map(t => ({...t}))
                        }));
                    } catch(e) {
                        console.error('Falha ao reidratar cronograma salvo:', e);
                        fullSchedule = [];
                    }
                } else {
                    setGenerateButtonState('pending');
                    fullSchedule = [];
                }
                // Inicializa filtros da lista ap√≥s carregar modelo
                setTimeout(initListFilters, 0);
            } catch (e) {
                console.error('Falha ao carregar modelo:', e);
            }
        }


        // --- GENERATE CYCLE ---
        let fullSchedule = []; // Array of objects: { date, tasks: [] }
        
        /**
         * Gera a estrutura do cronograma considerando Peso e quantidade de t√≥picos.
         * Par√¢metros de calibra√ß√£o:
         * - alpha: influ√™ncia dos t√≥picos (0 ignora, 1 usa s√≥ t√≥picos)
         * - beta: curva do Peso (1 linear, >1 amplifica, <1 suaviza)
         * - gamma: curva dos t√≥picos (1 linear, >1 amplifica, <1 suaviza)
         * - minRep/maxRep: limites de repeti√ß√µes por mat√©ria na sequ√™ncia base
         * - normalizeWeekly: ajusta proporcionalmente para caber nos slots semanais
         */
        function generateSchedule() {
            // Check if we have a saved schedule structure
            const savedScheduleJson = localStorage.getItem('estudoFiscalScheduleStructure');
            
            if (savedScheduleJson) {
                // Parse saved dates strings back to Date objects
                const rawSchedule = JSON.parse(savedScheduleJson);
                fullSchedule = rawSchedule.map(day => ({
                    ...day,
                    date: new Date(day.date),
                    tasks: day.tasks.map(t => ({...t})) // clone tasks
                }));
                
                // If saved schedule ends before current endDate, we might need to extend it?
                // For now, let's assume the user wants to keep the saved structure.
                // If they change config, they might need to clear storage or we implement a 'Regenerate' button.
                console.log("Loaded saved schedule structure.");
                return;
            }

            console.log("Generating new schedule structure...");

            const defaults = { alpha: 0.3, beta: 1.1, gamma: 0.8, minRep: 1, maxRep: 8, normalizeWeekly: true };
            const savedParams = JSON.parse(localStorage.getItem('estudoFiscalGenParams') || 'null');
            const params = Object.assign({}, defaults, savedParams || {});

            const topicCountMap = {};
            syllabusData.forEach(sec => sec.subjects.forEach(sub => {
                topicCountMap[sub.name] = Math.max(1, Array.isArray(sub.topics) ? sub.topics.length : 1);
            }));
            const topicCounts = subjectsConfig.map(s => topicCountMap[s.name] || 1);
            const avgTopics = topicCounts.length ? (topicCounts.reduce((a,b)=>a+b,0) / topicCounts.length) : 1;

            const pageCounts = subjectsConfig.map(s => s.qtdePaginas || 0);
            const avgPages = pageCounts.length ? (pageCounts.reduce((a,b)=>a+b,0) / pageCounts.length) : 0;

            // Calcula repeti√ß√µes por mat√©ria com calibra√ß√£o e normaliza√ß√£o semanal opcional
            const weeklySlots = (Array.isArray(slotsPorDia) ? slotsPorDia.reduce((a,b)=>a+b,0) : 0) || 1;
            const entries = subjectsConfig.map(sub => {
                const tc = topicCountMap[sub.name] || 1;
                const wLin = Number(sub.weight || 1);
                const w = Math.pow(wLin, params.beta);
                const ratio = Math.pow(tc / avgTopics, params.gamma);
                let raw = w * ((1 - params.alpha) + params.alpha * ratio);
                
                // Fator de P√°ginas (se houver dados)
                if (avgPages > 0) {
                    const pRatio = (sub.qtdePaginas || 0) / avgPages;
                    // Ajusta frequ√™ncia baseado em volume de p√°ginas (raiz quadrada para suavizar)
                    const pFactor = Math.pow(Math.max(0.1, pRatio), 0.5);
                    raw = raw * pFactor;
                }

                let reps = Math.max(params.minRep, Math.min(params.maxRep, Math.round(raw)));
                return { sub, reps };
            });
            if (params.normalizeWeekly) {
                const sumReps = entries.reduce((a,b)=>a+b.reps,0) || 1;
                const scale = weeklySlots / sumReps;
                entries.forEach(e => {
                    e.reps = Math.max(params.minRep, Math.min(params.maxRep, Math.round(e.reps * scale)));
                });
            }
            let baseSequence = [];
            entries.forEach(e => {
                for (let i = 0; i < e.reps; i++) baseSequence.push({ ...e.sub });
            });

            // Queue for consumption
            // We'll repeat this base sequence indefinitely
            let queue = [...baseSequence]; 
            
            let currentDate = new Date(startDate);

            while(currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const dayIdxMonFirst = (dayOfWeek + 6) % 7; // 0=Seg .. 6=Dom
                const hours = slotsPorDia[dayIdxMonFirst] || 0;
                
                let dayTasks = [];
                let attempts = 0; // fail-safe
                
                while(dayTasks.length < hours && attempts < 100) {
                    if(queue.length === 0) queue = [...baseSequence]; // Replenish
                    
                    // Peek the next candidate
                    let candidateIndex = 0;
                    let candidate = queue[candidateIndex];
                    
                    // Check if candidate is already in today's tasks
                    // Search forward in queue for a non-duplicate subject
                    while(dayTasks.some(t => t.subject === candidate.name) && candidateIndex < queue.length - 1) {
                        candidateIndex++;
                        candidate = queue[candidateIndex];
                    }
                    
                    // If we found a valid candidate (even if deep in queue)
                    if(!dayTasks.some(t => t.subject === candidate.name)) {
                        // Remove from queue at that index
                        queue.splice(candidateIndex, 1);
                        
                        // Add to day
                        const taskId = `task-${currentDate.getTime()}-${dayTasks.length}`;
                        dayTasks.push({
                            id: taskId,
                            subject: candidate.name,
                            type: candidate.type,
                            weight: candidate.weight,
                            completed: false
                        });
                    } else {
                        // If we exhausted queue and still overlap (rare given diversity), just take head
                        // But let's try to replenish first if queue is small
                        if(queue.length < 5) {
                             queue = [...queue, ...baseSequence];
                             continue; // try again with fresh stock
                        }
                        
                        // Force take head
                        candidate = queue.shift();
                        const taskId = `task-${currentDate.getTime()}-${dayTasks.length}`;
                        dayTasks.push({
                            id: taskId,
                            subject: candidate.name,
                            type: candidate.type,
                            weight: candidate.weight,
                            completed: false
                        });
                    }
                    attempts++;
                }

                fullSchedule.push({
                    date: new Date(currentDate),
                    tasks: dayTasks
                });

                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Save the generated structure
            localStorage.setItem('estudoFiscalScheduleStructure', JSON.stringify(fullSchedule));
            // Persist ciclo dedicado e log
            try {
                fetch('/api/cycle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule: fullSchedule })
                }).then(() => logEvent(`CYCLE: gerado (${fullSchedule.length} dias)`)).catch(()=>{});
            } catch(e) {}
        }

        

        // --- STATE MANAGEMENT ---
        // Load status from localStorage
        // Keys: 'estudoFiscalData' (status), 'estudoFiscalSyllabus' (syllabus)
        
        // Migration: Check for old 'sefazGoData' and migrate if 'estudoFiscalData' is missing
        let savedData = JSON.parse(localStorage.getItem('estudoFiscalData')) || {};
        const oldSefazData = JSON.parse(localStorage.getItem('sefazGoData'));
        
        if(oldSefazData && Object.keys(savedData).length === 0) {
            console.log("Migrating SEFAZ-GO status data to Estudo Fiscal...");
            savedData = oldSefazData;
            localStorage.setItem('estudoFiscalData', JSON.stringify(savedData));
        }
        
        /**
         * Aplica dados salvos (tempo, meta, notas) no cronograma carregado.
         */
        function applySavedStatusToSchedule() {
            const saved = JSON.parse(localStorage.getItem('estudoFiscalData')) || {};
            fullSchedule.forEach(day => {
                day.tasks.forEach(task => {
                    const data = saved[task.id];
                    if (data) {
                        task.note = data.note || '';
                        task.timeSpent = data.timeSpent || 0;
                        task.durationTarget = data.durationTarget || 3600;
                    } else {
                        task.note = task.note || '';
                        task.timeSpent = task.timeSpent || 0;
                        task.durationTarget = task.durationTarget || 3600;
                    }
                    const statusNow = deriveTaskStatus(task);
                    task.completed = (statusNow === 'concluido');
                });
            });
        }

        // Current Calendar View State
        let viewDate = new Date();
        if (viewDate < startDate) viewDate = new Date(startDate);

        // --- RENDER FUNCTIONS ---


        function switchTab(tabName) {
            // Update UI Tabs
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find the nav item that calls this function with the same tabName
            // Note: In inline onclick, 'this' might not be the element if not passed, 
            // but event.currentTarget is reliable if we use it.
            // However, since we might call this programmatically, let's look it up.
            const navItem = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick').includes(`'${tabName}'`));
            if(navItem) navItem.classList.add('active');

            // Update Views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const view = document.getElementById(`view-${tabName}`);
            if(view) view.classList.add('active');

            // Update Title
            const titles = {
                'calendar': 'Calend√°rio de Estudos',
                'subjects': 'Progresso por Mat√©ria',
                'list': 'Cronograma Completo',
                'syllabus': 'Conte√∫do Program√°tico',
                'time-stats': 'Tempo de Estudo',
                'history': 'Hist√≥rico de Estudos'
            };
            const titleEl = document.getElementById('page-title-text');
            if(titleEl) titleEl.textContent = titles[tabName] || 'Painel de Estudos';

            // Render espec√≠fico ao trocar de aba
            if (tabName === 'calendar') renderCalendar();
            else if (tabName === 'subjects') renderSubjects();
            else if (tabName === 'list') renderList();
            else if (tabName === 'syllabus') renderSyllabus();
            else if (tabName === 'time-stats') renderTimeStats();
            else if (tabName === 'history') renderHistory();
        }

        function setGenerateButtonState(state) {
            const btn = document.getElementById('generate-cycle-button');
            if (!btn) return;
            if (state === 'pending') {
                btn.style.background = '#ef4444';
                btn.innerHTML = '<i class="fas fa-play-circle"></i> Gerar Ciclo de Estudo';
            } else if (state === 'success') {
                btn.style.background = '#10b981';
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Ciclo Gerado Sucesso';
            } else {
                btn.style.background = 'var(--accent-color)';
                btn.innerHTML = '<i class="fas fa-play-circle"></i> Gerar Ciclo de Estudo';
            }
        }

        // --- CALENDAR LOGIC ---
        function changeMonth(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            
            document.getElementById('current-month-label').textContent = 
                viewDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDayIndex = (firstDay.getDay() + 6) % 7; // Semana iniciando na segunda
            const totalDays = lastDay.getDate();

            const container = document.getElementById('calendar-days');
            container.innerHTML = '';

            // Empty cells for previous month
            for(let i=0; i<startDayIndex; i++) {
                const div = document.createElement('div');
                div.className = 'day-cell empty';
                container.appendChild(div);
            }

            // Days
            for(let d=1; d<=totalDays; d++) {
                const currentDayDate = new Date(year, month, d);
                const daySchedule = fullSchedule.find(s => {
                    const a = new Date(s.date);
                    a.setHours(0,0,0,0);
                    const b = new Date(currentDayDate);
                    b.setHours(0,0,0,0);
                    return a.getTime() === b.getTime();
                });

                const div = document.createElement('div');
                div.className = 'day-cell';
                
                // Highlight today
                const today = new Date();
                if(currentDayDate.getDate() === today.getDate() && 
                   currentDayDate.getMonth() === today.getMonth() && 
                   currentDayDate.getFullYear() === today.getFullYear()) {
                    div.classList.add('today');
                }

                if(daySchedule) {
                    div.onclick = () => openDayModal(daySchedule);
                    
                    // Dots for tasks
                    const dotsHtml = daySchedule.tasks.map(t => {
                        const status = deriveTaskStatus(t);
                        const cls = status === 'concluido' ? 'done' : (status === 'nao_concluido' ? 'incomplete' : 'not-started');
                        return `<div class="dot ${cls}" title="${t.subject}"></div>`;
                    }).join('');

                    div.innerHTML = `
                        <div class="day-number">
                            ${d}
                            <span style="font-size: 0.7rem; color: #666;">${daySchedule.tasks.length}h</span>
                        </div>
                        <div class="day-dots">${dotsHtml}</div>
                    `;
                } else {
                    div.innerHTML = `<div class="day-number">${d}</div>`;
                    div.classList.add('empty'); // No study scheduled
                }

                container.appendChild(div);
            }
        }

        // --- MODAL LOGIC ---
        let currentModalDate = null;
        let currentDayTasksDraft = []; // Temporary storage for edits

        function openDayModal(daySchedule) {
            const modal = document.getElementById('day-modal');
            const list = document.getElementById('modal-task-list');
            const title = document.getElementById('modal-date-title');

            currentModalDate = daySchedule.date;
            title.textContent = daySchedule.date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
            list.innerHTML = '';

            // Clone tasks for draft
            currentDayTasksDraft = JSON.parse(JSON.stringify(daySchedule.tasks));

            renderModalTasks();
            modal.classList.add('open');
        }

        function renderModalTasks() {
            const list = document.getElementById('modal-task-list');
            list.innerHTML = '';

            currentDayTasksDraft.forEach((task, index) => {
                const item = document.createElement('div');
                item.className = 'task-item';
                
                const derived = deriveTaskStatus(task);
                const statusChipClass = derived === 'concluido' ? 'ok' : (derived === 'nao_concluido' ? 'ic' : 'ns');
                const statusLabel = derived === 'concluido' ? 'Conclu√≠do' : (derived === 'nao_concluido' ? 'N√£o Conclu√≠do' : 'N√£o Iniciado');

                const timeSpent = task.timeSpent || 0;
                // Default Meta logic: if not set, 1h (3600s). Can be edited.
                if(!task.durationTarget) task.durationTarget = 3600; 
                const durationTarget = task.durationTarget;
                
                const percent = Math.min(100, Math.round((timeSpent / durationTarget) * 100));
                const remaining = Math.max(0, durationTarget - timeSpent);
                
                const formattedTime = formatTime(timeSpent);
                const formattedTarget = formatTime(durationTarget);
                const formattedRemaining = formatTime(remaining);

                item.innerHTML = `
                    <div class="task-header-row" style="flex-wrap: wrap;">
                        <div class="task-info" style="min-width: 200px;">
                            <div class="task-name" style="font-size: 1.1rem; margin-bottom: 4px;">${task.subject}</div>
                            <div class="task-meta">
                                <span class="tag ${'badge-w' + (task.weight || 1)}" 
                                      style="padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                    ${task.type}
                                </span>
                                <span style="margin-left:8px; font-size: 0.85rem; color: #888;">Peso ${task.weight}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
                            <span class="status-pill ${statusChipClass}"><i class="fas fa-circle"></i> ${statusLabel}</span>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div style="margin-top: 12px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; color: #ccc;">
                            <span>Progresso: <b>${percent}%</b></span>
                            <span>Falta: <b>${formattedRemaining}</b></span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
                            <div style="width: ${percent}%; height: 100%; background: ${percent >= 100 ? 'var(--success-color)' : 'var(--accent-color)'}; transition: width 0.3s ease;"></div>
                        </div>
                        
                        <!-- Meta Editor -->
                        <div style="display: flex; align-items: center; gap: 15px; font-size: 0.85rem; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #888;">Meta:</span>
                                <div class="meta-chip">
                                    <button class="step-btn" onclick="adjustMeta(${index}, 'hours', -1)">-</button>
                                    <div class="chip-seg"><span>Horas</span><b>${Math.floor(durationTarget / 3600)}</b></div>
                                    <button class="step-btn" onclick="adjustMeta(${index}, 'hours', 1)">+</button>
                                    <div class="divider"></div>
                                    <button class="step-btn" onclick="adjustMeta(${index}, 'minutes', -5)">-</button>
                                    <div class="chip-seg"><span>Min</span><b>${Math.floor((durationTarget % 3600) / 60)}</b></div>
                                    <button class="step-btn" onclick="adjustMeta(${index}, 'minutes', 5)">+</button>
                                </div>
                                <div class="preset-group">
                                    <button class="preset-btn" onclick="setMetaPreset(${index}, 1800)">30m</button>
                                    <button class="preset-btn" onclick="setMetaPreset(${index}, 2700)">45m</button>
                                    <button class="preset-btn" onclick="setMetaPreset(${index}, 3600)">1h</button>
                                    <button class="preset-btn" onclick="setMetaPreset(${index}, 5400)">1h30</button>
                                    <button class="preset-btn" onclick="setMetaPreset(${index}, 7200)">2h</button>
                                    ${task._startSuggested ? `<button class="start-btn" onclick="startActiveSession(${index})"><i class='fas fa-play'></i> Iniciar Estudo</button>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="color: #888;">Estudado:</span>
                                <span style="color: white; font-family: monospace;">${formattedTime}</span>
                            </div>
                        </div>
                    </div>
                    
                    

                    <div style="margin-top: 10px;">
                        <textarea class="task-observation" placeholder="Anota√ß√µes..." onchange="updateDraftNote(${index}, this.value)">${task.note || ''}</textarea>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        window.updateDraftMeta = function(index, type, value) {
            const task = currentDayTasksDraft[index];
            let currentTarget = task.durationTarget || 3600;
            let h = Math.floor(currentTarget / 3600);
            let m = Math.floor((currentTarget % 3600) / 60);
            
            const val = parseInt(value) || 0;
            
            if(type === 'hours') h = val;
            if(type === 'minutes') m = val;
            
            task.durationTarget = (h * 3600) + (m * 60);
            // Re-render to update bars
            renderModalTasks(); 
            commitDraft();
        }

        /**
         * Ajusta meta de horas/minutos via bot√µes incrementais.
         */
        window.adjustMeta = function(index, type, delta) {
            const task = currentDayTasksDraft[index];
            const current = task.durationTarget || 3600;
            let h = Math.floor(current / 3600);
            let m = Math.floor((current % 3600) / 60);
            if (type === 'hours') {
                h = Math.max(0, Math.min(23, h + delta));
            } else if (type === 'minutes') {
                m = Math.max(0, Math.min(59, m + delta));
            }
            task.durationTarget = (h * 3600) + (m * 60);
            renderModalTasks();
            commitDraft();
        }

        /**
         * Define meta por presets predefinidos (em segundos).
         */
        window.setMetaPreset = function(index, seconds) {
            const task = currentDayTasksDraft[index];
            task.durationTarget = seconds;
            task._startSuggested = true;
            renderModalTasks();
            commitDraft();
        }

        

        function closeModal() {
            document.getElementById('day-modal').classList.remove('open');
            currentDayTasksDraft = []; // Clear draft
        }

        // Draft Updates (only updates temporary array)
        let activeTimerInterval = null;
        let activeTimerTaskId = null;

        function startTimer(index) {
            if(activeTimerInterval) clearInterval(activeTimerInterval);
            
            // Only one timer active at a time for simplicity in this version
            // Find any other task that might be 'studying' in the draft and reset it?
            // Or just allow local timer.
            
            // We need to track the start time. 
            // In a real app we'd save this to DB. Here we use a temp variable or localStorage if needed.
            // But since this is a draft modal, we just run the timer visually.
            // Wait, user said "quando eu colocar ESTUDANDO, vai abrir um cronometro".
            
            // Let's assume the timer starts from 0 or previous accumulated time.
            const task = currentDayTasksDraft[index];
            const startTime = Date.now();
            
            // Store start timestamp in task draft to calculate diff later
            task._timerStart = startTime; 
            
            // Update UI every second
            activeTimerInterval = setInterval(() => {
                const now = Date.now();
                const diff = now - task._timerStart;
                
                // Add diff to existing time (if any)
                // Note: timeSpent is in seconds. 
                const totalSeconds = (task.timeSpent || 0) + Math.floor(diff / 1000);
                
                const timerEl = document.getElementById(`timer-${index}`);
                if(timerEl) timerEl.textContent = formatTime(totalSeconds);
            }, 1000);
            
            activeTimerTaskId = index;
        }

        function stopTimer(index) {
            if(activeTimerInterval && activeTimerTaskId === index) {
                clearInterval(activeTimerInterval);
                activeTimerInterval = null;
                
                // Calculate final time and save to draft
                const task = currentDayTasksDraft[index];
                if(task._timerStart) {
                    const diff = Date.now() - task._timerStart;
                    task.timeSpent = (task.timeSpent || 0) + Math.floor(diff / 1000);
                    delete task._timerStart;
                }
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function deriveTaskStatus(task) {
            const spent = Number(task.timeSpent || 0);
            const target = Number(task.durationTarget || 3600);
            if (task._inProgress) return 'nao_concluido';
            if (spent >= Math.max(0, target - 60)) return 'concluido';
            if (spent > 0) return 'nao_concluido';
            return 'nao_iniciado';
        }

        // --- SESSION & HISTORY LOGIC ---
        // Load history with migration
        let studyHistory = JSON.parse(localStorage.getItem('estudoFiscalStudyHistory')) || [];
        const oldSefazHistory = JSON.parse(localStorage.getItem('sefazStudyHistory'));
        if (oldSefazHistory && studyHistory.length === 0) {
            console.log("Migrating SEFAZ-GO history to Estudo Fiscal...");
            studyHistory = oldSefazHistory;
            localStorage.setItem('estudoFiscalStudyHistory', JSON.stringify(studyHistory));
        }

        let activeSession = null; // { taskIndex, startTime, subject, timerInterval }

        // Triggered when "ESTUDANDO" is selected in modal
        function startActiveSession(index) {
            // Close modal first
            closeModal();

            const task = currentDayTasksDraft[index]; // Note: this is draft, but we need the real task or at least ID
            // Since we close modal, we should use the real data. 
            // But wait, user might have modified other things in modal.
            // Let's assume selecting "ESTUDANDO" saves the state and starts session.
            
            // To be safe, we need to know WHICH real task this is.
            // currentDayTasksDraft[index] corresponds to fullSchedule's day tasks.
            const dayObj = fullSchedule.find(d => d.date.getTime() === currentModalDate.getTime());
            const realTask = dayObj.tasks[index];
            // Marca em progresso e persiste status "N√£o Conclu√≠do" imediatamente
            realTask._inProgress = true;
            const savedData = JSON.parse(localStorage.getItem('estudoFiscalData')) || {};
            if(!savedData[realTask.id]) savedData[realTask.id] = {};
            savedData[realTask.id].status = 'nao_concluido';
            savedData[realTask.id].note = realTask.note || '';
            savedData[realTask.id].timeSpent = realTask.timeSpent || 0;
            savedData[realTask.id].durationTarget = realTask.durationTarget || 3600;
            localStorage.setItem('estudoFiscalData', JSON.stringify(savedData));
            renderCalendar();
            renderList();

            // If there's already a session, pause it? Or stop?
            if(activeSession) {
                alert("J√° existe uma sess√£o ativa. Finalize-a primeiro.");
                return;
            }

            activeSession = {
                dayDate: currentModalDate,
                taskIndex: index,
                subject: realTask.subject,
                startTime: Date.now(),
                elapsedAtStart: realTask.timeSpent || 0, // seconds
                elapsedSession: 0,
                paused: false,
                interval: null
            };

            // Show Bar
            const bar = document.getElementById('active-study-bar');
            bar.classList.add('visible');
            document.getElementById('bar-subject-name').textContent = activeSession.subject;
            
            // Request Notification Permission
            if("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }

            updateBarTimer();
            resumeTimer();
        }

        function togglePauseResume() {
            if(!activeSession) return;
            if(activeSession.paused) {
                resumeTimer();
                document.getElementById('btn-pause-resume').innerHTML = '<i class="fas fa-pause"></i> Pausar';
            } else {
                pauseTimer();
                document.getElementById('btn-pause-resume').innerHTML = '<i class="fas fa-play"></i> Continuar';
            }
        }

        function resumeTimer() {
            if(!activeSession) return;
            activeSession.paused = false;
            activeSession.lastResumeTime = Date.now();
            
            activeSession.interval = setInterval(() => {
                const now = Date.now();
                // We don't add diff to elapsedSession directly every tick to avoid drift, just for display
                // Actually simpler: 
                activeSession.elapsedSession += 1;
                activeSession.lastResumeTime = now; // reset for next tick
                
                // Check Alarm (1h = 3600s)
                const total = activeSession.elapsedAtStart + activeSession.elapsedSession;
                if(total === 3600) { 
                    playAlarm();
                    // Visual cue
                    const timerEl = document.getElementById('bar-timer-display');
                    if(timerEl) {
                        timerEl.style.color = '#ff6b6b';
                        timerEl.style.textShadow = '0 0 10px #ff6b6b';
                        setTimeout(() => {
                             timerEl.style.color = '#fff';
                             timerEl.style.textShadow = 'none';
                        }, 5000);
                    }
                    // Notification if supported
                    if("Notification" in window && Notification.permission === "granted") {
                        new Notification("Meta Batida!", { body: "Voc√™ completou 1 hora de estudo!" });
                    }
                }
                
                updateBarTimer();
            }, 1000);
        }

        function playAlarm() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                
                const ctx = new AudioContext();
                const now = ctx.currentTime;
                
                // 3 beeps
                [0, 0.8, 1.6].forEach(offset => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    
                    // Sound config
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now + offset); // A5
                    osc.frequency.exponentialRampToValueAtTime(440, now + offset + 0.4);
                    
                    gain.gain.setValueAtTime(0.1, now + offset);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + offset + 0.4);
                    
                    osc.start(now + offset);
                    osc.stop(now + offset + 0.5);
                });
            } catch(e) {
                console.error("Erro ao tocar alarme:", e);
            }
        }

        function pauseTimer() {
            if(!activeSession) return;
            activeSession.paused = true;
            clearInterval(activeSession.interval);
        }

        function updateBarTimer() {
            if(!activeSession) return;
            const total = activeSession.elapsedAtStart + activeSession.elapsedSession;
            document.getElementById('bar-timer-display').textContent = formatTime(total);
        }

        function finishSession() {
            if(!activeSession) return;
            pauseTimer();
            // Open Note Modal
            document.getElementById('note-modal').classList.add('open');
            // Clear textarea
            document.getElementById('note-textarea').value = '';
        }

        function cancelSession() {
            if(confirm('Deseja cancelar a sess√£o atual? O tempo n√£o ser√° salvo.')) {
                pauseTimer();
                document.getElementById('active-study-bar').classList.remove('visible');
                // Reverte status para o derivado do tempo atual (provavelmente "N√£o Iniciado")
                if(activeSession) {
                    const dayObj = fullSchedule.find(d => d.date.getTime() === activeSession.dayDate.getTime());
                    if(dayObj) {
                        const task = dayObj.tasks[activeSession.taskIndex];
                        delete task._inProgress;
                        const d = deriveTaskStatus(task);
                        const savedData = JSON.parse(localStorage.getItem('estudoFiscalData')) || {};
                        if(!savedData[task.id]) savedData[task.id] = {};
                        savedData[task.id].status = d;
                        savedData[task.id].note = task.note || '';
                        savedData[task.id].timeSpent = task.timeSpent || 0;
                        savedData[task.id].durationTarget = task.durationTarget || 3600;
                        localStorage.setItem('estudoFiscalData', JSON.stringify(savedData));
                    }
                }
                renderCalendar();
                renderList();
                activeSession = null;
            }
        }

        function cancelNote() {
            document.getElementById('note-modal').classList.remove('open');
            // Resume timer if cancelled?
            // User might want to go back to timer.
            // Let's keep timer paused.
        }

        function saveNote() {
            if(!activeSession) return;
            
            const note = document.getElementById('note-textarea').value;
            const now = new Date();
            
            // 1. Add to History
            const historyItem = {
                id: Date.now().toString(),
                date: now.toISOString(), // ISO string for sorting
                subject: activeSession.subject,
                duration: activeSession.elapsedSession, // Only what was studied NOW
                startTime: activeSession.startTime,
                note: note
            };
            
            studyHistory.unshift(historyItem); // Add to top
            localStorage.setItem('estudoFiscalStudyHistory', JSON.stringify(studyHistory));

            // 2. Update Cycle Task (Total Time)
            const dayObj = fullSchedule.find(d => d.date.getTime() === activeSession.dayDate.getTime());
            if(dayObj) {
                const task = dayObj.tasks[activeSession.taskIndex];
                task.timeSpent = (task.timeSpent || 0) + activeSession.elapsedSession;
                
                // Determine Status based on Target
                // Default target is 3600s (1h) if not set.
                // If durationTarget was saved in memory (task object), use it.
                // Note: durationTarget might need to be loaded from savedData if not in task object yet (init).
                // But we load savedData at init.
                const target = task.durationTarget || 3600;
                const derivedStatus = deriveTaskStatus(task);
                task.completed = (derivedStatus === 'concluido');

                // Append note?
                if(note) {
                    const timeString = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                    task.note = (task.note ? task.note + '\n' : '') + `[${timeString}] ${note}`;
                }
                
                // Save to Global Data (Using Generic Key)
                const savedData = JSON.parse(localStorage.getItem('estudoFiscalData')) || {};
                if(!savedData[task.id]) savedData[task.id] = {};
                savedData[task.id].status = derivedStatus; 
                savedData[task.id].note = task.note;
                savedData[task.id].timeSpent = task.timeSpent;
                savedData[task.id].durationTarget = task.durationTarget || 3600;
                localStorage.setItem('estudoFiscalData', JSON.stringify(savedData));
                localStorage.setItem('estudoFiscalScheduleStructure', JSON.stringify(fullSchedule));
                syncToDisk();
            }

            // 3. Cleanup
            document.getElementById('note-modal').classList.remove('open');
            document.getElementById('active-study-bar').classList.remove('visible');
            activeSession = null;

            // 4. Refresh
            renderHistory();
            renderCalendar();
            renderTimeStats();
            updateStats();
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if(!container) return;
            container.innerHTML = '';

            if(studyHistory.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-muted)">Nenhum hist√≥rico registrado ainda.</div>';
                return;
            }

            // Group by Date (Day)
            const groups = {};
            studyHistory.forEach(item => {
                const d = new Date(item.date);
                const dateKey = d.toLocaleDateString('pt-BR');
                if(!groups[dateKey]) {
                    groups[dateKey] = {
                        dateObj: d,
                        totalTime: 0,
                        items: []
                    };
                }
                groups[dateKey].items.push(item);
                groups[dateKey].totalTime += item.duration;
            });

            // Sort groups by date desc
            const sortedDates = Object.keys(groups).sort((a,b) => {
                // simple parser dd/mm/yyyy
                const [da, ma, ya] = a.split('/');
                const [db, mb, yb] = b.split('/');
                return new Date(yb, mb-1, db) - new Date(ya, ma-1, da);
            }); // Ascending? No we want descending.
            // Wait, default sort is weird.
            // Better to use the dateObj we stored.
            const sortedGroups = Object.values(groups).sort((a,b) => b.dateObj - a.dateObj);

            sortedGroups.forEach(group => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'history-day-group';
                
                const dateStr = group.dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                
                let itemsHtml = '';
                group.items.forEach(item => {
                    const startT = new Date(item.startTime).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                    
                    // Subject color (random or consistent?)
                    // Let's use accent color for now
                    
                    itemsHtml += `
                        <div class="history-item">
                            <div class="history-item-header">
                                <div class="history-subject">
                                    <span class="history-dot" style="background-color: var(--accent-color)"></span>
                                    ${item.subject}
                                </div>
                                <div class="history-times">
                                    <span><i class="far fa-clock"></i> ${startT}</span>
                                    <span><i class="fas fa-stopwatch"></i> ${formatTime(item.duration)}</span>
                                </div>
                            </div>
                            ${item.note ? `<div class="history-note">${item.note}</div>` : ''}
                        </div>
                    `;
                });

                groupDiv.innerHTML = `
                    <div class="history-day-header">
                        <div class="history-date">${dateStr}</div>
                        <div class="history-total-time">${formatTime(group.totalTime)}</div>
                    </div>
                    ${itemsHtml}
                `;
                container.appendChild(groupDiv);
            });
        }

        

        window.updateDraftTime = function(index, type, value) {
            const task = currentDayTasksDraft[index];
            let currentSeconds = task.timeSpent || 0;
            let h = Math.floor(currentSeconds / 3600);
            let m = Math.floor((currentSeconds % 3600) / 60);
            let s = currentSeconds % 60; // preserve seconds if any

            const val = parseInt(value) || 0;

            if(type === 'hours') {
                h = val;
            } else if(type === 'minutes') {
                m = val;
            } else if(type === 'seconds') {
                s = val;
            }

            task.timeSpent = (h * 3600) + (m * 60) + s;
            // We should re-render to update progress bar if time changes
            renderModalTasks();
            // And keep manual edit open
            const editDiv = document.getElementById(`manual-edit-${index}`);
            if(editDiv) editDiv.style.display = 'block';
            commitDraft();
        }

        window.updateDraftNote = function(index, noteText) {
            currentDayTasksDraft[index].note = noteText;
            commitDraft();
        }

        // Commit Changes
        window.saveModalChanges = function() {
            // Find the original day object in fullSchedule
            const dayObj = fullSchedule.find(d => d.date.getTime() === currentModalDate.getTime());
            
            if(dayObj) {
                // Apply drafts to real object
                dayObj.tasks = JSON.parse(JSON.stringify(currentDayTasksDraft));
                
                // Recalcular conclu√≠do com base no status derivado
                dayObj.tasks.forEach(t => { const d = deriveTaskStatus(t); t.completed = (d === 'concluido'); });

                // Save to Storage
                const savedData = JSON.parse(localStorage.getItem('estudoFiscalData')) || {};
                
                dayObj.tasks.forEach(t => {
                    if(!savedData[t.id]) savedData[t.id] = {};
                    const d = deriveTaskStatus(t);
                    savedData[t.id].status = d;
                    savedData[t.id].note = t.note;
                    savedData[t.id].timeSpent = t.timeSpent || 0;
                    savedData[t.id].durationTarget = t.durationTarget || 3600;
                });

                localStorage.setItem('estudoFiscalData', JSON.stringify(savedData));
                localStorage.setItem('estudoFiscalScheduleStructure', JSON.stringify(fullSchedule));
                // Persistir ciclo e sincronizar
                try { fetch('/api/cycle', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ schedule: fullSchedule }) }).catch(()=>{}); } catch(e) {}
                syncToDisk();
                
                // Refresh Views
                renderCalendar();
                renderSubjects();
                renderList();
                updateStats();
                renderTimeStats();
                renderHistory(); // Also update history view
                
                // Close
                closeModal();
            }
        }

        // --- SUBJECTS VIEW ---
        function renderSubjects() {
            const container = document.getElementById('subjects-container');
            container.innerHTML = '';

            subjectsConfig.forEach(sub => {
                // Calculate stats
                let total = 0;
                let done = 0;
                
                fullSchedule.forEach(day => {
                    day.tasks.forEach(t => {
                        if(t.subject === sub.name) {
                            total++;
                            if(t.completed) done++;
                        }
                    });
                });

                const percent = total === 0 ? 0 : Math.round((done / total) * 100);

                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `
                    <div class="subject-header">
                        <div class="subject-title">${sub.name}</div>
                        <div class="subject-badge ${'badge-w' + (sub.weight || 1)}">Peso ${sub.weight}</div>
                    </div>
                    <div class="subject-stat">
                        <span>Horas planejadas</span>
                        <span>${total}h</span>
                    </div>
                    <div class="subject-stat">
                        <span>Conclu√≠do</span>
                        <span>${done}h (${percent}%)</span>
                    </div>
                    <div class="progress-circle">
                        <div class="progress-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- LIST VIEW ---
        function renderList() {
            // Render only first 100 or create pagination if needed. For now render all but careful with DOM.
            // Let's render only the upcoming days + past uncompleted? No, user asked for full cycle.
            // To avoid lag, let's render a limited set or just simple table.
            // For now, let's stick to the first 200 rows to prevent freezing, or implement simple load more.
            // Actually, let's just render all, browser can handle ~2000 simple rows usually.
            
            const tbody = document.getElementById('list-tbody');
            // Check if already rendered to avoid re-rendering heavy DOM constantly
            if(tbody.children.length > 0 && !document.getElementById('view-list').classList.contains('active')) return;

            tbody.innerHTML = '';
            
            // Limit to first 100 for performance initially, or maybe logic to show current week?
            // Let's show current month tasks.
            const currentMonthTasks = fullSchedule.filter(d => 
                d.date.getMonth() === viewDate.getMonth() && 
                d.date.getFullYear() === viewDate.getFullYear()
            );

            // Flatten
            let rows = [];
            fullSchedule.forEach(d => {
                d.tasks.forEach(t => {
                    rows.push({ date: d.date, task: t });
                });
            });

            // Apply filters
            const f = window.listFilters || {};
            rows = rows.filter(row => {
                const statusOk = !f.status || (f.status === 'feito' ? row.task.completed : !row.task.completed);
                const subjectOk = !f.subject || row.task.subject === f.subject;
                const startOk = !f.start || row.date >= f.start;
                const endOk = !f.end || row.date <= f.end;
                return statusOk && subjectOk && startOk && endOk;
            });

            // Let's just render the first 100 and maybe a "Load more" button if needed, 
            // but for now let's render today +/- 15 days?
            // Or just render all. It's about 150 days * 5-8 tasks = ~1000 rows. It's fine.
            
            // Optimization: Render string HTML first then inject
            let html = '';
            rows.forEach(row => {
                const st = deriveTaskStatus(row.task);
                const label = st === 'concluido' ? 'Conclu√≠do' : (st === 'nao_concluido' ? 'N√£o Conclu√≠do' : 'N√£o Iniciado');
                const color = st === 'concluido' ? 'var(--success-color)' : (st === 'nao_concluido' ? 'var(--warning-color)' : 'var(--accent-color)');
                html += `
                    <tr>
                        <td>
                            <span style="color: ${color}">
                                <i class="fas fa-circle"></i> ${label}
                            </span>
                        </td>
                        <td>${row.date.toLocaleDateString('pt-BR')}</td>
                        <td>${row.date.toLocaleDateString('pt-BR', {weekday: 'short'})}</td>
                        <td>${row.task.subject}</td>
                        <td>${row.task.type}</td>
                    </tr>
                `;
            });
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="color: var(--text-muted); padding: 20px;">Nenhum item no cronograma. Gere o ciclo para listar as tarefas.</td></tr>';
            } else {
                tbody.innerHTML = html;
            }
        }

        /**
         * Inicializa e aplica filtros da Lista Completa.
         */
        function initListFilters() {
            window.listFilters = { status: '', subject: '', start: null, end: null };
            const subjSelect = document.getElementById('filter-subject');
            if (subjSelect) {
                subjSelect.innerHTML = '<option value="">Todas</option>' + subjectsConfig.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            }
            const statusSelect = document.getElementById('filter-status');
            const startInput = document.getElementById('filter-start');
            const endInput = document.getElementById('filter-end');
            if (statusSelect) statusSelect.onchange = () => { window.listFilters.status = statusSelect.value; renderList(); };
            if (subjSelect) subjSelect.onchange = () => { window.listFilters.subject = subjSelect.value; renderList(); };
            if (startInput) startInput.onchange = () => { window.listFilters.start = startInput.value ? new Date(startInput.value) : null; renderList(); };
            if (endInput) endInput.onchange = () => { window.listFilters.end = endInput.value ? new Date(endInput.value) : null; renderList(); };
        }
        function clearListFilters() {
            const statusSelect = document.getElementById('filter-status');
            const subjSelect = document.getElementById('filter-subject');
            const startInput = document.getElementById('filter-start');
            const endInput = document.getElementById('filter-end');
            if (statusSelect) statusSelect.value = '';
            if (subjSelect) subjSelect.value = '';
            if (startInput) startInput.value = '';
            if (endInput) endInput.value = '';
            window.listFilters = { status: '', subject: '', start: null, end: null };
            renderList();
        }

        // --- GLOBAL STATS ---
        function updateStats() {
            const today = new Date();
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            document.getElementById('days-left-stat').textContent = diffDays > 0 ? diffDays : 0;

            let totalTasks = 0;
            let completedTasks = 0;
            fullSchedule.forEach(d => {
                totalTasks += d.tasks.length;
                completedTasks += d.tasks.filter(t => t.completed).length;
            });

            const percent = totalTasks === 0 ? 0 : Math.round((completedTasks / totalTasks) * 100);
            document.getElementById('total-progress-stat').textContent = percent + '%';
            document.getElementById('total-progress-bar').style.width = percent + '%';

            // Calculate Streak
            let streak = 0;
            const todayDate = new Date();
            todayDate.setHours(0,0,0,0);
            
            // Check past days
            // We need to check if ANY task was done or history exists for the day
            // Let's iterate backwards
            for(let i = 0; i < 365; i++) { // Check up to a year back
                const d = new Date(todayDate);
                d.setDate(d.getDate() - i);
                
                // Check tasks
                const dayTasks = fullSchedule.find(day => 
                    day.date.getDate() === d.getDate() &&
                    day.date.getMonth() === d.getMonth() &&
                    day.date.getFullYear() === d.getFullYear()
                );
                
                let hasActivity = false;
                if(dayTasks) {
                    if(dayTasks.tasks.some(t => t.completed || t.timeSpent > 0)) hasActivity = true;
                }
                
                // Check history
                if(!hasActivity) {
                    // Check raw history array
                    const dayStart = d.getTime();
                    const dayEnd = dayStart + 86400000;
                    
                    const hasHistory = studyHistory.some(h => {
                        const hTime = new Date(h.date).getTime();
                        return hTime >= dayStart && hTime < dayEnd;
                    });
                    if(hasHistory) hasActivity = true;
                }

                if(hasActivity) {
                    streak++;
                } else {
                    // If it's today and we haven't done anything yet, don't break streak if yesterday was active
                    if (i === 0) continue; 
                    else break;
                }
            }
            document.getElementById('streak-stat').textContent = `${streak} dias`;
        }

        // --- TIME STATS LOGIC ---
        let studyTimeChart = null;

        function renderTimeStats() {
            const chartAvailable = (typeof Chart !== 'undefined');
            // Calculate total time per subject
            const subjectTimes = {};
            let totalSeconds = 0;

            // Initialize with config
            subjectsConfig.forEach(sub => {
                subjectTimes[sub.name] = 0;
            });

            // Sum up from fullSchedule
            fullSchedule.forEach(day => {
                day.tasks.forEach(t => {
                    if(t.timeSpent) {
                        subjectTimes[t.subject] = (subjectTimes[t.subject] || 0) + t.timeSpent;
                        totalSeconds += t.timeSpent;
                    }
                });
            });

            // Convert to array for sorting
            const sortedSubjects = Object.entries(subjectTimes)
                .map(([name, seconds]) => ({ name, seconds }))
                .sort((a, b) => b.seconds - a.seconds);

            // Render List
            const listContainer = document.getElementById('time-stats-list');
            if(listContainer) {
                listContainer.innerHTML = '';
                if(totalSeconds === 0) {
                    listContainer.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Nenhum tempo registrado ainda.</div>';
                } else {
                    sortedSubjects.forEach(item => {
                        if(item.seconds > 0) {
                            const percent = ((item.seconds / totalSeconds) * 100).toFixed(1);
                            
                            // Filter history for this subject
                            const subjectHistory = studyHistory
                                .filter(h => h.subject === item.name)
                                .sort((a, b) => new Date(b.date) - new Date(a.date));
                                
                            const row = document.createElement('div');
                            row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                            row.style.padding = '8px 0';
                            
                            let historyHtml = '';
                            if (subjectHistory.length > 0) {
                                historyHtml = '<div style="margin-top:5px; padding-left:10px; border-left: 2px solid var(--border-color);">';
                                subjectHistory.forEach(h => {
                                    const d = new Date(h.date);
                                    historyHtml += `
                                        <div style="margin-bottom: 8px; font-size: 0.85rem;">
                                            <div style="color: var(--text-muted); display:flex; justify-content:space-between;">
                                                <span><i class="far fa-calendar-alt"></i> ${d.toLocaleDateString('pt-BR')} <i class="far fa-clock" style="margin-left:5px;"></i> ${d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}</span>
                                                <span style="color: var(--text-color); font-weight:600;">${formatTime(h.duration)}</span>
                                            </div>
                                            ${h.note ? `<div style="color: #bbb; font-style: italic; font-size: 0.85rem; margin-top:2px;">"${h.note}"</div>` : ''}
                                        </div>
                                    `;
                                });
                                historyHtml += '</div>';
                            }

                            row.innerHTML = `
                                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                                    <div>
                                        <div style="font-weight: 500;">${item.name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                                            ${formatTime(item.seconds)}
                                        </div>
                                    </div>
                                    <div style="font-weight: 600; color: var(--accent-color);">${percent}% <i class="fas fa-chevron-down" style="font-size:0.7rem; margin-left:5px;"></i></div>
                                </div>
                                <div style="display:none; margin-top:8px;">
                                    ${historyHtml || '<div style="font-size:0.8rem; color:var(--text-muted);">Sem hist√≥rico detalhado.</div>'}
                                </div>
                            `;
                            listContainer.appendChild(row);
                        }
                    });
                }
            }

            // Render Chart
            const ctx = document.getElementById('studyTimeChart');
            if(ctx && chartAvailable) {
                if(studyTimeChart) studyTimeChart.destroy();
                const colors = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#E7E9ED','#76D7C4','#F1948A','#85C1E9','#F7DC6F','#D2B4DE'];
                const labels = sortedSubjects.filter(i => i.seconds > 0).map(i => i.name);
                const data = sortedSubjects.filter(i => i.seconds > 0).map(i => i.seconds / 3600);
                if(labels.length > 0) {
                    studyTimeChart = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: colors.slice(0, labels.length), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e0e0e0', boxWidth: 10, font: { size: 10 } } } } } });
                }
            }

            // Render PDF Stats
            const pdfContainer = document.getElementById('pdf-stats-list');
            if(pdfContainer) {
                pdfContainer.innerHTML = '';
                const sortedPdf = [...subjectsConfig].sort((a,b) => (b.qtdePaginas || 0) - (a.qtdePaginas || 0));
                
                if(sortedPdf.every(s => !s.qtdePdf && !s.qtdePaginas)) {
                     pdfContainer.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Nenhum dado de PDF/P√°ginas configurado.</div>';
                } else {
                    sortedPdf.forEach(sub => {
                        const pdfs = sub.qtdePdf || 0;
                        const pags = sub.qtdePaginas || 0;
                        if(pdfs > 0 || pags > 0) {
                             const row = document.createElement('div');
                             row.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                             row.style.padding = '8px 0';
                             row.innerHTML = `
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="font-weight: 500;">${sub.name}</div>
                                    <div style="text-align:right;">
                                        <div style="font-weight: 600; color: var(--accent-color);">${pags} p√°gs</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">${pdfs} PDFs</div>
                                    </div>
                                </div>
                             `;
                             pdfContainer.appendChild(row);
                        }
                    });
                }
            }
        }

        /**
         * Inicializa painel de calibra√ß√£o e sincroniza campos.
         */
        function initCalibrationPanel() {
            const defaults = { alpha: 0.3, beta: 1.1, gamma: 0.8, minRep: 1, maxRep: 8, normalizeWeekly: true };
            const saved = JSON.parse(localStorage.getItem('estudoFiscalGenParams') || 'null') || defaults;
            const alphaR = document.getElementById('alpha-range');
            const alphaN = document.getElementById('alpha-num');
            const betaR = document.getElementById('beta-range');
            const betaN = document.getElementById('beta-num');
            const gammaR = document.getElementById('gamma-range');
            const gammaN = document.getElementById('gamma-num');
            const minN = document.getElementById('minRep-num');
            const maxN = document.getElementById('maxRep-num');
            const normC = document.getElementById('normalizeWeekly-check');
            if (!alphaR) return; // panel not in current view
            alphaR.value = saved.alpha; alphaN.value = saved.alpha;
            betaR.value = saved.beta; betaN.value = saved.beta;
            gammaR.value = saved.gamma; gammaN.value = saved.gamma;
            minN.value = saved.minRep; maxN.value = saved.maxRep; normC.checked = !!saved.normalizeWeekly;
            alphaR.oninput = () => { alphaN.value = alphaR.value; };
            alphaN.oninput = () => { alphaR.value = alphaN.value; };
            betaR.oninput = () => { betaN.value = betaR.value; };
            betaN.oninput = () => { betaR.value = betaN.value; };
            gammaR.oninput = () => { gammaN.value = gammaR.value; };
            gammaN.oninput = () => { gammaR.value = gammaN.value; };
        }

        /**
         * Salva par√¢metros de calibra√ß√£o.
         */
        function saveCalibrationParams() {
            const params = {
                alpha: parseFloat(document.getElementById('alpha-num').value),
                beta: parseFloat(document.getElementById('beta-num').value),
                gamma: parseFloat(document.getElementById('gamma-num').value),
                minRep: parseInt(document.getElementById('minRep-num').value) || 1,
                maxRep: parseInt(document.getElementById('maxRep-num').value) || 8,
                normalizeWeekly: !!document.getElementById('normalizeWeekly-check').checked
            };
            localStorage.setItem('estudoFiscalGenParams', JSON.stringify(params));
            alert('Par√¢metros aplicados. Gere o ciclo para efetivar no cronograma.');
        }

        /**
         * Renderiza preview da distribui√ß√£o de repeti√ß√µes por mat√©ria.
         */
        function renderCalibrationPreview() {
            const container = document.getElementById('calibration-preview');
            if (!container) return;
            const defaults = { alpha: 0.3, beta: 1.1, gamma: 0.8, minRep: 1, maxRep: 8, normalizeWeekly: true };
            const params = {
                alpha: parseFloat(document.getElementById('alpha-num').value),
                beta: parseFloat(document.getElementById('beta-num').value),
                gamma: parseFloat(document.getElementById('gamma-num').value),
                minRep: parseInt(document.getElementById('minRep-num').value) || defaults.minRep,
                maxRep: parseInt(document.getElementById('maxRep-num').value) || defaults.maxRep,
                normalizeWeekly: !!document.getElementById('normalizeWeekly-check').checked
            };
            const topicCountMap = {};
            syllabusData.forEach(sec => sec.subjects.forEach(sub => {
                topicCountMap[sub.name] = Math.max(1, Array.isArray(sub.topics) ? sub.topics.length : 1);
            }));
            const topicCounts = subjectsConfig.map(s => topicCountMap[s.name] || 1);
            const avgTopics = topicCounts.length ? (topicCounts.reduce((a,b)=>a+b,0) / topicCounts.length) : 1;
            const weeklySlots = (Array.isArray(slotsPorDia) ? slotsPorDia.reduce((a,b)=>a+b,0) : 0) || 1;
            const entries = subjectsConfig.map(sub => {
                const tc = topicCountMap[sub.name] || 1;
                const wLin = Number(sub.weight || 1);
                const w = Math.pow(wLin, params.beta);
                const ratio = Math.pow(tc / avgTopics, params.gamma);
                const raw = w * ((1 - params.alpha) + params.alpha * ratio);
                let reps = Math.max(params.minRep, Math.min(params.maxRep, Math.round(raw)));
                return { name: sub.name, reps };
            });
            if (params.normalizeWeekly) {
                const sumReps = entries.reduce((a,b)=>a+b.reps,0) || 1;
                const scale = weeklySlots / sumReps;
                entries.forEach(e => { e.reps = Math.max(params.minRep, Math.min(params.maxRep, Math.round(e.reps * scale))); });
            }
            container.innerHTML = entries.map(e => {
                const pct = Math.round((e.reps / Math.max(1, entries.reduce((a,b)=>Math.max(a,b.reps), 1))) * 100);
                return `<div style="display:flex; align-items:center; gap:10px;"><span style="width:200px;">${e.name}</span><div style="flex:1; height:8px; background:#333; border-radius:4px; overflow:hidden;"><div style="width:${pct}%; height:100%; background: var(--accent-color);"></div></div><span style="width:40px; text-align:right;">${e.reps}</span></div>`;
            }).join('');
        }

        // --- SYLLABUS LOGIC ---
        let syllabusData = [
            {
                category: "Conhecimentos B√°sicos",
                subjects: [
                    {
                        name: "L√≠ngua Portuguesa",
                        topics: [
                            "Interpreta√ß√£o de textos", "Ortografia oficial", "Acentua√ß√£o gr√°fica", "Classes de palavras", "Sintaxe da ora√ß√£o e do per√≠odo", "Pontua√ß√£o", "Concord√¢ncia nominal e verbal", "Reg√™ncia nominal e verbal", "Crase", "Significa√ß√£o das palavras"
                        ]
                    },
                    {
                        name: "Exatas",
                        topics: [
                            "L√≥gica proposicional", "Argumenta√ß√£o l√≥gica", "Juros simples e compostos", "Descontos", "Sistemas de amortiza√ß√£o", "Estat√≠stica descritiva (m√©dia, moda, mediana)", "Probabilidade", "Distribui√ß√µes de probabilidade", "Amostragem", "Infer√™ncia estat√≠stica"
                        ]
                    },
                    {
                        name: "Direito Constitucional",
                        topics: [
                            "Direitos e garantias fundamentais", "Organiza√ß√£o do Estado", "Administra√ß√£o P√∫blica", "Organiza√ß√£o dos Poderes", "Sistema Tribut√°rio Nacional", "Finan√ßas P√∫blicas", "Ordem Econ√¥mica e Financeira"
                        ]
                    },
                    {
                        name: "Direito Administrativo",
                        topics: [
                            "Princ√≠pios da Adm. P√∫blica", "Organiza√ß√£o administrativa", "Atos administrativos", "Poderes administrativos", "Licita√ß√µes e Contratos (Lei 14.133/2021)", "Servi√ßos p√∫blicos", "Responsabilidade civil do Estado", "Improbidade Administrativa", "Processo Administrativo"
                        ]
                    },
                    {
                        name: "Direito Financeiro",
                        topics: [
                            "Atividade financeira do Estado", "Lei 4.320/1964", "Lei de Responsabilidade Fiscal", "Or√ßamento P√∫blico (PPA, LDO, LOA)", "Receita P√∫blica", "Despesa P√∫blica", "D√≠vida P√∫blica"
                        ]
                    },
                    {
                        name: "Direito Civil",
                        topics: [
                            "LINDB", "Pessoas naturais e jur√≠dicas", "Bens", "Fatos jur√≠dicos", "Neg√≥cio jur√≠dico", "Prescri√ß√£o e decad√™ncia", "Obriga√ß√µes", "Contratos"
                        ]
                    },
                    {
                        name: "Empresarial",
                        topics: [
                            "Direito de Empresa", "Empres√°rio", "Estabelecimento empresarial", "Nome empresarial", "Sociedades", "T√≠tulos de cr√©dito", "Fal√™ncia e recupera√ß√£o de empresas"
                        ]
                    },
                    {
                        name: "Penal",
                        topics: [
                            "Aplica√ß√£o da lei penal", "Teoria do crime", "Crimes contra a pessoa", "Crimes contra o patrim√¥nio", "Crimes contra a f√© p√∫blica", "Crimes contra a Administra√ß√£o P√∫blica", "Crimes contra a ordem tribut√°ria"
                        ]
                    },
                    {
                        name: "Economia",
                        topics: ["Microeconomia (Demanda, Oferta, Mercado)", "Macroeconomia (Contas Nacionais, Moeda, Infla√ß√£o)"]
                    },
                    {
                        name: "Contabilidade Geral",
                        topics: [
                            "Estrutura Conceitual (CPC 00)", "Patrim√¥nio", "Escritura√ß√£o", "Demonstra√ß√µes Cont√°beis (Balan√ßo, DRE, DMPL, DFC)", "Ativo Circulante e N√£o Circulante", "Passivo e PL"
                        ]
                    },
                    {
                        name: "Realidade do Estado",
                        topics: ["Aspectos hist√≥ricos, geogr√°ficos, econ√¥micos, sociais e culturais do Estado"]
                    }
                ]
            },
            {
                category: "Conhecimentos Espec√≠ficos",
                subjects: [
                    {
                        name: "Tecnologia da Informa√ß√£o",
                        topics: [
                            "Banco de Dados (Conceitos, SQL)", "Seguran√ßa da Informa√ß√£o", "Governan√ßa de TI (COBIT, ITIL)", "An√°lise de Dados (Big Data, BI)", "Lei Geral de Prote√ß√£o de Dados (LGPD)"
                        ]
                    },
                    {
                        name: "Auditoria",
                        topics: [
                            "Normas Brasileiras de Contabilidade (NBC TA)", "Planejamento da auditoria", "Evid√™ncia de auditoria", "Procedimentos de auditoria", "Amostragem", "Relat√≥rios de auditoria", "Auditoria interna x externa"
                        ]
                    },
                    {
                        name: "Contabilidade Geral e Avan√ßada",
                        topics: [
                            "Consolida√ß√£o de Demonstra√ß√µes", "Investimentos (MEP)", "Combina√ß√£o de Neg√≥cios", "CPC 01 (Redu√ß√£o ao Valor Recuper√°vel)", "CPC 06 (Arrendamentos)", "CPC 27 (Imobilizado)"
                        ]
                    },
                    {
                        name: "Contabilidade P√∫blica",
                        topics: [
                            "PCASP", "Demonstra√ß√µes Cont√°beis Aplicadas ao Setor P√∫blico", "Receitas e Despesas sob o enfoque patrimonial", "MCASP"
                        ]
                    },
                    {
                        name: "Contabilidade de Custos",
                        topics: [
                            "Terminologia de Custos", "Custeio por Absor√ß√£o e Vari√°vel", "Custeio Baseado em Atividades (ABC)", "An√°lise Custo-Volume-Lucro", "Margem de Contribui√ß√£o"
                        ]
                    },
                    {
                        name: "Direito Tribut√°rio I",
                        topics: [
                            "Sistema Tribut√°rio Nacional (CF/88)", "C√≥digo Tribut√°rio Nacional (CTN)", "Obriga√ß√£o tribut√°ria", "Cr√©dito tribut√°rio", "Suspens√£o, Extin√ß√£o e Exclus√£o do Cr√©dito"
                        ]
                    },
                    {
                        name: "Direito Tribut√°rio II ‚Äì Reforma Tribut√°ria",
                        topics: [
                            "Reforma Tribut√°ria (EC 132/2023)", "IBS e CBS", "Imposto Seletivo", "Regras de Transi√ß√£o", "Impactos na legisla√ß√£o vigente"
                        ]
                    },
                    {
                        name: "Legisla√ß√£o Tribut√°ria Estadual",
                        topics: [
                            "C√≥digo Tribut√°rio Estadual", "ICMS (Regras Estaduais)", "IPVA", "ITCD", "Processo Administrativo Tribut√°rio"
                        ]
                    }
                ]
            }
        ];

        (function(){
            const rawModel = localStorage.getItem('estudoFiscalModel');
            if(rawModel){
                try{
                    const model = JSON.parse(rawModel);
                    if(Array.isArray(model.syllabus)) syllabusData = model.syllabus;
                }catch(e){}
            }
        })();

        let syllabusProgress = JSON.parse(localStorage.getItem('estudoFiscalSyllabus')) || {};
        
        // Migrate Syllabus
        const oldSefazSyllabus = JSON.parse(localStorage.getItem('sefazCycle_syllabus'));
        if(oldSefazSyllabus && Object.keys(syllabusProgress).length === 0) {
            console.log("Migrating Syllabus data...");
            const mapping = {
                "Racioc√≠nio L√≥gico, Mat. Financeira e Estat√≠stica": "Exatas",
                "Direito Empresarial": "Empresarial",
                "Direito Penal": "Penal",
                "Realidade de Goi√°s": "Realidade do Estado"
            };
            
            Object.keys(oldSefazSyllabus).forEach(oldKey => {
                const newKey = mapping[oldKey] || oldKey;
                syllabusProgress[newKey] = oldSefazSyllabus[oldKey];
            });
            
            localStorage.setItem('estudoFiscalSyllabus', JSON.stringify(syllabusProgress));
        }

        function toggleSyllabusItem(subjectName, topicIndex, checked) {
            if (!syllabusProgress[subjectName]) {
                syllabusProgress[subjectName] = [];
            }
            if (syllabusProgress[subjectName].length <= topicIndex) {
                // Fill gaps
                for(let i=0; i<=topicIndex; i++) {
                    if(typeof syllabusProgress[subjectName][i] === 'undefined') syllabusProgress[subjectName][i] = false;
                }
            }
            syllabusProgress[subjectName][topicIndex] = checked;
            localStorage.setItem('estudoFiscalSyllabus', JSON.stringify(syllabusProgress));
            
            // Update UI partially to prevent closing accordion
            updateSyllabusUI(subjectName);
        }

        function updateSyllabusUI(subjectName) {
            const savedTopics = syllabusProgress[subjectName] || [];
            
            // Find syllabus data
            let syllabusSubject = null;
            for(const section of syllabusData) {
                const found = section.subjects.find(s => s.name === subjectName);
                if(found) {
                    syllabusSubject = found;
                    break;
                }
            }
            if(!syllabusSubject) return;

            // Find config for weight
            const config = subjectsConfig.find(s => s.name === subjectName);
            const weight = config ? config.weight : 1;

            let completedCount = 0;
            syllabusSubject.topics.forEach((_, idx) => {
                if (savedTopics[idx]) completedCount++;
            });
            const percent = Math.round((completedCount / syllabusSubject.topics.length) * 100);
            
            const sanitizedName = subjectName.replace(/\s+/g, '_').replace(/[^\w]/g, '');
            
            // Update Meta Text
            const metaEl = document.getElementById(`meta-${sanitizedName}`);
            if(metaEl) {
                metaEl.innerHTML = `
                    <span class="tag ${'badge-w' + (weight || 1)}" style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;">
                        Peso ${weight}
                    </span>
                    ‚Ä¢ ${completedCount}/${syllabusSubject.topics.length} t√≥picos (${percent}%)
                `;
            }
            
            // Update Progress Bar
            const progEl = document.getElementById(`prog-${sanitizedName}`);
            if(progEl) {
                progEl.style.width = `${percent}%`;
            }
        }

        window.toggleAccordion = function(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            const icon = header.querySelector('.accordion-icon');
            icon.textContent = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
        }

        function renderSyllabus() {
            const container = document.getElementById('syllabus-container');
            container.innerHTML = '';

            syllabusData.forEach(section => {
                const secTitle = document.createElement('h4');
                secTitle.textContent = section.category;
                secTitle.style.margin = '20px 0 10px 0';
                secTitle.style.color = 'var(--accent-color)';
                container.appendChild(secTitle);

                section.subjects.forEach(sub => {
                    const config = subjectsConfig.find(s => s.name === sub.name);
                    const weight = config ? config.weight : 1;
                    const savedTopics = syllabusProgress[sub.name] || [];
                    
                    let completedCount = 0;
                    sub.topics.forEach((_, idx) => {
                        if (savedTopics[idx]) completedCount++;
                    });
                    const percent = Math.round((completedCount / sub.topics.length) * 100);
                    
                    const sanitizedName = sub.name.replace(/\s+/g, '_').replace(/[^\w]/g, '');

                    const card = document.createElement('div');
                    card.className = 'syllabus-category';
                    
                    card.innerHTML = `
                        <div class="syllabus-header" onclick="toggleAccordion(this)">
                            <div class="syllabus-title-group">
                                <span class="accordion-icon">‚ñ∂</span>
                                <div>
                                    <div class="syllabus-title">${sub.name}</div>
                                    <div class="syllabus-meta" id="meta-${sanitizedName}">
                                        <span class="tag ${'badge-w' + (weight || 1)}" style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;">
                                            Peso ${weight}
                                        </span>
                                        ‚Ä¢ ${completedCount}/${sub.topics.length} t√≥picos (${percent}%)
                                    </div>
                                </div>
                            </div>
                            <div class="progress-mini">
                                <div class="progress-mini-fill" id="prog-${sanitizedName}" style="width: ${percent}%"></div>
                            </div>
                        </div>
                        <div class="syllabus-content">
                            ${sub.topics.map((topic, idx) => `
                                <div class="topic-item">
                                    <input type="checkbox" class="topic-checkbox" 
                                        ${savedTopics[idx] ? 'checked' : ''} 
                                        onchange="toggleSyllabusItem('${sub.name}', ${idx}, this.checked)">
                                    <span class="topic-text">${topic}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if(!container) return;
            
            container.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0; color:var(--accent-color);">Hist√≥rico de Estudos</h3>
                    <div style="font-size:0.9rem; color:var(--text-muted);">Total: ${formatTime(studyHistory.reduce((acc, curr) => acc + curr.duration, 0))}</div>
                </div>
            `;
            
            if(studyHistory.length === 0) {
                container.innerHTML += '<div style="text-align:center; color:var(--text-muted); padding:40px;">Nenhum estudo registrado ainda.</div>';
                return;
            }
            
            // Sort by date desc
            const sorted = [...studyHistory].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            const list = document.createElement('div');
            list.className = 'history-list';
            
            sorted.forEach(h => {
                const d = new Date(h.date);
                const item = document.createElement('div');
                item.style.background = 'var(--card-bg)';
                item.style.border = '1px solid var(--border-color)';
                item.style.borderRadius = '8px';
                item.style.padding = '15px';
                item.style.marginBottom = '10px';
                item.style.display = 'flex';
                item.style.justifyContent = 'space-between';
                item.style.alignItems = 'center';
                
                item.innerHTML = `
                    <div>
                        <div style="font-weight:600; color:var(--text-color);">${h.subject}</div>
                        <div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">
                            <i class="far fa-calendar"></i> ${d.toLocaleDateString('pt-BR')} 
                            <i class="far fa-clock" style="margin-left:8px;"></i> ${d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}
                        </div>
                        ${h.note ? `<div style="margin-top:8px; font-style:italic; color:#bbb; font-size:0.9rem;">"${h.note}"</div>` : ''}
                    </div>
                    <div style="font-weight:bold; font-size:1.1rem; color:var(--accent-color);">
                        ${formatTime(h.duration)}
                    </div>
                `;
                list.appendChild(item);
            });
            
            container.appendChild(list);
        }

        // --- BACKUP & RESTORE ---
        function downloadBackup() {
            const data = {
                estudoFiscalData: JSON.parse(localStorage.getItem('estudoFiscalData') || '{}'),
                estudoFiscalSyllabus: JSON.parse(localStorage.getItem('estudoFiscalSyllabus') || '{}'),
                estudoFiscalStudyHistory: JSON.parse(localStorage.getItem('estudoFiscalStudyHistory') || '[]'),
                estudoFiscalScheduleStructure: JSON.parse(localStorage.getItem('estudoFiscalScheduleStructure') || 'null'),
                backupDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_estudo_fiscal_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerRestore() {
            document.getElementById('restore-input').click();
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if(confirm(`Restaurar backup de ${new Date(data.backupDate).toLocaleDateString('pt-BR')}? Isso substituir√° os dados atuais.`)) {
                        if(data.estudoFiscalData) localStorage.setItem('estudoFiscalData', JSON.stringify(data.estudoFiscalData));
                        if(data.estudoFiscalSyllabus) localStorage.setItem('estudoFiscalSyllabus', JSON.stringify(data.estudoFiscalSyllabus));
                        
                        if(data.estudoFiscalStudyHistory) {
                            localStorage.setItem('estudoFiscalStudyHistory', JSON.stringify(data.estudoFiscalStudyHistory));
                        } else if(data.sefazStudyHistory) {
                            localStorage.setItem('estudoFiscalStudyHistory', JSON.stringify(data.sefazStudyHistory));
                        }

                        if(data.estudoFiscalScheduleStructure) localStorage.setItem('estudoFiscalScheduleStructure', JSON.stringify(data.estudoFiscalScheduleStructure));
                        
                        alert('Backup restaurado com sucesso! A p√°gina ser√° recarregada.');
                        location.reload();
                    }
                } catch(err) {
                    alert('Erro ao ler arquivo de backup: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // --- MODEL IMPORT/EXPORT (CSV) ---
        /**
         * Exporta um CSV de modelo com colunas padr√£o e exemplos.
         */
        function downloadModelTemplateCSV() {
            const headers = ['Concurso','Orgao','InicioCiclo','FimCiclo','Categoria','Materia','Peso','Tickets','Topico'];
            const rows = [];
            rows.push(['SEFAZ - Exemplo','Secretaria da Fazenda','2025-12-16','2026-12-31','Basico','L√≠ngua Portuguesa','1','1','Interpreta√ß√£o de textos']);
            rows.push(['SEFAZ - Exemplo','Secretaria da Fazenda','2025-12-16','2026-12-31','Basico','Exatas','1','1','L√≥gica proposicional']);
            rows.push(['SEFAZ - Exemplo','Secretaria da Fazenda','2025-12-16','2026-12-31','Especifico','Auditoria','3','3','Planejamento da auditoria']);
            const csv = [headers.join(','), ...rows.map(r => r.map(s => '"' + String(s).replace(/"/g,'""') + '"').join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'modelo_concurso.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Abre seletor de arquivo para importar CSV de modelo.
         */
        function triggerImportModel() {
            document.getElementById('import-model-input').click();
        }

        /**
         * Importa CSV selecionado, parseia e aplica como novo modelo.
         */
        function importModelCSV(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const rows = parseCSV(text);
                    const model = buildModelFromCSV(rows);
                    if(!model) {
                        alert('CSV inv√°lido. Verifique as colunas: Concurso, Orgao, InicioCiclo, FimCiclo, Categoria, Materia, Peso, Tickets, Topico');
                        return;
                    }
                    applyImportedModel(model);
                    alert('Modelo importado com sucesso! Cronograma regenerado.');
                } catch(err) {
                    alert('Erro ao importar CSV: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        /**
         * Parser CSV simples com suporte a aspas e v√≠rgulas.
         */
        function parseCSV(text) {
            const lines = text.replace(/\r/g,'').split('\n').filter(l => l.trim().length > 0);
            const rows = [];
            for (const line of lines) {
                const result = [];
                let cur = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (inQuotes) {
                        if (ch === '"') {
                            if (line[i+1] === '"') { cur += '"'; i++; }
                            else { inQuotes = false; }
                        } else cur += ch;
                    } else {
                        if (ch === '"') inQuotes = true;
                        else if (ch === ',') { result.push(cur); cur = ''; }
                        else cur += ch;
                    }
                }
                result.push(cur);
                rows.push(result.map(v => v.trim()));
            }
            return rows;
        }

        // Normaliza valores de data (string dd/mm/yyyy, yyyy-mm-dd ou serial Excel) para 'yyyy-mm-dd'
        function normalizeDateValue(val) {
            if (val == null) return '';
            if (typeof val === 'number' && typeof XLSX !== 'undefined' && XLSX.SSF) {
                try { return XLSX.SSF.format('yyyy-mm-dd', val); } catch(e) {}
            }
            const s = String(val).trim();
            const iso = /^\d{4}-\d{2}-\d{2}$/;
            const br = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            if (iso.test(s)) return s;
            const m = s.match(br);
            if (m) return `${m[3]}-${m[2]}-${m[1]}`;
            // Fallback: Date.parse
            const d = new Date(s);
            if (!isNaN(d.getTime())) return d.toISOString().slice(0,10);
            return '';
        }

        function capitalizeWord(s) {
            const t = String(s || '').trim();
            if (!t) return '';
            return t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
        }

        function normalizeCategoryLabel(cat) {
            const raw = String(cat || '').trim();
            if (!raw) return 'Conhecimentos B√°sicos';
            const lower = raw.toLowerCase();
            if (lower.startsWith('conhecimentos')) return raw;
            if (['basico','b√°sico'].includes(lower)) return 'Conhecimentos B√°sicos';
            if (['especifico','espec√≠fico'].includes(lower)) return 'Conhecimentos Espec√≠ficos';
            return 'Conhecimentos ' + capitalizeWord(raw);
        }

        function shortCategoryLabelFromTitle(title) {
            const t = String(title || '').trim();
            const m = t.match(/^conhecimentos\s+(.*)$/i);
            return m ? m[1] : t;
        }

        /**
         * Constr√≥i o modelo a partir das linhas do CSV.
         */
        function buildModelFromCSV(rows) {
            if (!rows || rows.length < 2) return null;
            const header = rows[0].map(h => h.toLowerCase());
            const idx = {
                concurso: header.indexOf('concurso'),
                orgao: header.indexOf('orgao'),
                inicio: header.indexOf('iniciociclo'),
                fim: header.indexOf('fimciclo'),
                seg: header.indexOf('seg'),
                ter: header.indexOf('ter'),
                qua: header.indexOf('qua'),
                qui: header.indexOf('qui'),
                sex: header.indexOf('sex'),
                sab: header.indexOf('sab'),
                dom: header.indexOf('dom'),
                categoria: header.indexOf('categoria'),
                materia: header.indexOf('materia'),
                peso: header.indexOf('peso'),
                tickets: header.indexOf('tickets'),
                topico: header.indexOf('topico')
            };
            const required = ['concurso','orgao','inicio','fim','categoria','materia','peso','tickets','topico'];
            if (required.some(k => idx[k] === -1)) return null;

            const materiasMap = new Map();
            const syllabusMap = new Map(); // key: categoria|materia -> { category, name, topics: [] }
            let concurso = '';
            let orgao = '';
            let inicioCiclo = '';
            let fimCiclo = '';
            let slotsPorDiaLocal = null;

            for (let r = 1; r < rows.length; r++) {
                const row = rows[r];
                if (row.length === 0) continue;
                concurso = concurso || row[idx.concurso];
                orgao = orgao || row[idx.orgao];
                inicioCiclo = inicioCiclo || normalizeDateValue(row[idx.inicio]);
                fimCiclo = fimCiclo || normalizeDateValue(row[idx.fim]);
                if (!slotsPorDiaLocal && idx.seg !== -1) {
                    const seg = Number(row[idx.seg] || 0);
                    const ter = Number(row[idx.ter] || 0);
                    const qua = Number(row[idx.qua] || 0);
                    const qui = Number(row[idx.qui] || 0);
                    const sex = Number(row[idx.sex] || 0);
                    const sab = Number(row[idx.sab] || 0);
                    const dom = Number(row[idx.dom] || 0);
                    const arr = [seg,ter,qua,qui,sex,sab,dom];
                    if (arr.some(n => !isNaN(n))) slotsPorDiaLocal = arr.map(n => Number(n)||0);
                }
                const rawCategoria = row[idx.categoria] || 'Basico';
                const materia = row[idx.materia];
                if (!materia) continue;
                let peso = Number(row[idx.peso] || 1);
                peso = Math.min(3, Math.max(1, isNaN(peso) ? 1 : peso));
                let tickets = Number(row[idx.tickets]);
                tickets = Math.max(1, isNaN(tickets) ? peso : tickets);
                const topico = row[idx.topico] || '';

                const categoriaCompleta = normalizeCategoryLabel(rawCategoria);
                const categoriaCurta = shortCategoryLabelFromTitle(categoriaCompleta);

                if (!materiasMap.has(materia)) materiasMap.set(materia, { nome: materia, tipo: categoriaCurta, peso, tickets });
                const key = categoriaCompleta + '|' + materia;
                if (!syllabusMap.has(key)) syllabusMap.set(key, { category: categoriaCompleta, name: materia, topics: [] });
                if (topico) syllabusMap.get(key).topics.push(topico);
            }

            const materias = Array.from(materiasMap.values());
            const syllabusArray = [];
            const byCategory = {};
            syllabusMap.forEach(item => {
                const cat = item.category;
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push({ name: item.name, topics: item.topics.length ? item.topics : ['T√≥pico 1'] });
            });
            Object.keys(byCategory).forEach(cat => {
                syllabusArray.push({ category: cat, subjects: byCategory[cat] });
            });

            const model = { concurso, orgao, inicioCiclo, fimCiclo, materias, syllabus: syllabusArray };
            if (slotsPorDiaLocal) model.slotsPorDia = slotsPorDiaLocal;
            return model;
        }

        /**
         * Constr√≥i o modelo a partir de duas abas do Excel: Gerais e Conteudo.
         */
        function buildModelFromSheets(generalRows, contentRows) {
            if (!generalRows || generalRows.length < 2 || !contentRows || contentRows.length < 2) return null;
            const gh = generalRows[0].map(h => String(h).toLowerCase());
            const gi = {
                concurso: gh.indexOf('concurso'),
                orgao: gh.indexOf('orgao'),
                inicio: gh.indexOf('iniciociclo'),
                fim: gh.indexOf('fimciclo'),
                seg: gh.indexOf('seg'), ter: gh.indexOf('ter'), qua: gh.indexOf('qua'),
                qui: gh.indexOf('qui'), sex: gh.indexOf('sex'), sab: gh.indexOf('sab'), dom: gh.indexOf('dom')
            };
            if ([gi.concurso, gi.orgao, gi.inicio, gi.fim].some(v => v === -1)) return null;
            const g = generalRows[1];
            const concurso = g[gi.concurso];
            const orgao = g[gi.orgao];
            const inicioCiclo = normalizeDateValue(g[gi.inicio]);
            const fimCiclo = normalizeDateValue(g[gi.fim]);
            const slotsPorDiaLocal = [g[gi.seg], g[gi.ter], g[gi.qua], g[gi.qui], g[gi.sex], g[gi.sab], g[gi.dom]].map(n => Number(n)||0);

            const ch = contentRows[0].map(h => String(h).toLowerCase());
            const ci = {
                categoria: ch.indexOf('categoria'),
                materia: ch.indexOf('materia'),
                peso: ch.indexOf('peso'),
                tickets: ch.indexOf('tickets'),
                topico: ch.indexOf('topico'),
                qtdePdf: ch.indexOf('qtde pdf'),
                qtdePaginas: ch.indexOf('qtde paginas')
            };
            if ([ci.categoria, ci.materia, ci.peso, ci.tickets, ci.topico].some(v => v === -1)) return null;

            const materiasMap = new Map();
            const syllabusMap = new Map();
            for (let r = 1; r < contentRows.length; r++) {
                const row = contentRows[r];
                if (!row || row.length === 0) continue;
                const categoriaRaw = row[ci.categoria] || 'Basico';
                const materia = row[ci.materia];
                if (!materia) continue;
                let peso = Number(row[ci.peso] || 1);
                peso = Math.min(3, Math.max(1, isNaN(peso) ? 1 : peso));
                let tickets = Number(row[ci.tickets]);
                tickets = Math.max(1, isNaN(tickets) ? peso : tickets);
                let qtdePdf = Number(row[ci.qtdePdf] || 0);
                let qtdePaginas = Number(row[ci.qtdePaginas] || 0);
                const topico = row[ci.topico] || '';
                const categoriaCompleta = normalizeCategoryLabel(categoriaRaw);
                const categoriaCurta = shortCategoryLabelFromTitle(categoriaCompleta);
                if (!materiasMap.has(materia)) materiasMap.set(materia, { nome: materia, tipo: categoriaCurta, peso, tickets, qtdePdf, qtdePaginas });
                const key = categoriaCompleta + '|' + materia;
                if (!syllabusMap.has(key)) syllabusMap.set(key, { category: categoriaCompleta, name: materia, topics: [] });
                if (topico) syllabusMap.get(key).topics.push(topico);
            }

            const materias = Array.from(materiasMap.values());
            const byCategory = {};
            syllabusMap.forEach(item => {
                const cat = item.category;
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push({ name: item.name, topics: item.topics.length ? item.topics : [] });
            });
            const syllabusArray = Object.keys(byCategory).map(cat => ({ category: cat, subjects: byCategory[cat] }));

            return { concurso, orgao, inicioCiclo, fimCiclo, slotsPorDia: slotsPorDiaLocal, materias, syllabus: syllabusArray };
        }

        /**
         * Aplica o modelo importado no sistema e regenera cronograma.
         */
        function applyImportedModel(model) {
            localStorage.setItem('estudoFiscalModel', JSON.stringify(model));
            loadModelFromStorage();
            localStorage.removeItem('estudoFiscalScheduleStructure');
            fullSchedule = [];
            setGenerateButtonState('pending');
            init();
            syncToDisk();
        }

        function generateCycleFromModel() {
            const raw = localStorage.getItem('estudoFiscalModel');
            if (raw) loadModelFromStorage();
            localStorage.removeItem('estudoFiscalScheduleStructure');
            fullSchedule = [];
            generateSchedule();
            setGenerateButtonState('success');
            init();
            syncToDisk();
        }

        /**
         * Exporta o modelo atual (mat√©rias + syllabus) para CSV.
         */
        function exportCurrentModelCSV() {
            const headers = ['Concurso','Orgao','InicioCiclo','FimCiclo','Categoria','Materia','Peso','Tickets','Topico'];
            const modelRaw = localStorage.getItem('estudoFiscalModel');
            const model = modelRaw ? JSON.parse(modelRaw) : null;
            const concurso = model?.concurso || 'Modelo Atual';
            const orgao = model?.orgao || '';
            const inicio = (model?.inicioCiclo) || startDate.toISOString().slice(0,10);
            const fim = (model?.fimCiclo) || endDate.toISOString().slice(0,10);

            const rows = [];
            // Map subjects to categories via syllabusData when poss√≠vel
            const catMap = {};
            syllabusData.forEach(sec => sec.subjects.forEach(s => { catMap[s.name] = sec.category; }));
            subjectsConfig.forEach(m => {
                const categoria = (catMap[m.name] || (m.type === 'Espec√≠fico' ? 'Conhecimentos Espec√≠ficos' : 'Conhecimentos B√°sicos'));
                const catLabel = categoria.includes('Espec√≠') ? 'Especifico' : 'Basico';
                // Add one row without t√≥pico
                rows.push([concurso, orgao, inicio, fim, catLabel, m.name, String(m.weight), String(m.tickets), '']);
                // Add topic rows
                const sec = syllabusData.find(sec => sec.subjects.some(s => s.name === m.name));
                const subj = sec ? sec.subjects.find(s => s.name === m.name) : null;
                if (subj && Array.isArray(subj.topics)) {
                    subj.topics.forEach(t => rows.push([concurso, orgao, inicio, fim, catLabel, m.name, String(m.weight), String(m.tickets), t]));
                }
            });

            const csv = [headers.join(','), ...rows.map(r => r.map(s => '"' + String(s).replace(/"/g,'""') + '"').join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'modelo_atual.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- MODEL IMPORT/EXPORT (Excel - XLSX) ---
        /**
         * Baixa um workbook Excel de modelo com cabe√ßalhos e exemplos.
         */
        function downloadModelTemplateXLSX() {
            const concurso = 'Concurso - Modelo';
            const orgao = '√ìrg√£o';
            const inicio = startDate.toLocaleDateString('pt-BR');
            const fim = endDate.toLocaleDateString('pt-BR');
            const generalHeaders = ['Concurso','Orgao','InicioCiclo','FimCiclo','Seg','Ter','Qua','Qui','Sex','Sab','Dom'];
            const generalSheet = [generalHeaders, [concurso, orgao, inicio, fim, ...slotsPorDia]];

            const contentHeaders = ['Categoria','Materia','Peso','Tickets','Topico'];
            const contentRows = [];
            const catMap = {};
            syllabusData.forEach(sec => sec.subjects.forEach(s => { catMap[s.name] = sec.category; }));
            subjectsConfig.forEach(m => {
                const categoria = (catMap[m.name] || (m.type === 'Espec√≠fico' ? 'Conhecimentos Espec√≠ficos' : 'Conhecimentos B√°sicos'));
                const catLabel = categoria.includes('Espec√≠') ? 'Especifico' : 'Basico';
                contentRows.push([catLabel, m.name, String(m.weight), String(m.tickets), '']);
                const sec = syllabusData.find(sec => sec.subjects.some(s => s.name === m.name));
                const subj = sec ? sec.subjects.find(s => s.name === m.name) : null;
                const topics = subj && Array.isArray(subj.topics) && subj.topics.length > 0 ? subj.topics : [];
                topics.forEach(t => contentRows.push([catLabel, m.name, String(m.weight), String(m.tickets), t]));
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(generalSheet), 'Gerais');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([contentHeaders, ...contentRows]), 'Conteudo');
            XLSX.writeFile(wb, 'modelo_ciclo_estudo.xlsx');
        }

        /**
         * Exporta o modelo atual para Excel (inclui t√≥picos do syllabus).
         */
        function exportCurrentModelXLSX() {
            const modelRaw = localStorage.getItem('estudoFiscalModel');
            const model = modelRaw ? JSON.parse(modelRaw) : null;
            const concurso = model?.concurso || (document.getElementById('page-subtitle-text')?.textContent.replace('Foco na meta: ','') || 'Modelo Atual');
            const orgao = model?.orgao || '';
            const inicio = (model?.inicioCiclo ? new Date(model.inicioCiclo) : startDate).toLocaleDateString('pt-BR');
            const fim = (model?.fimCiclo ? new Date(model.fimCiclo) : endDate).toLocaleDateString('pt-BR');
            const slots = Array.isArray(model?.slotsPorDia) ? model.slotsPorDia : slotsPorDia;
            const generalHeaders = ['Concurso','Orgao','InicioCiclo','FimCiclo','Seg','Ter','Qua','Qui','Sex','Sab','Dom'];
            const generalSheet = [generalHeaders, [concurso, orgao, inicio, fim, ...slots]];

            const contentHeaders = ['Categoria','Materia','Peso','Tickets','Topico'];
            const rows = [];
            if (model) {
                const materiaConfigMap = new Map();
                if (Array.isArray(model.materias)) {
                    model.materias.forEach(m => materiaConfigMap.set(m.nome, m));
                }
                if (Array.isArray(model.syllabus)) {
                    model.syllabus.forEach(sec => {
                        const catShort = shortCategoryLabelFromTitle(sec.category);
                        (sec.subjects || []).forEach(sub => {
                            const cfg = materiaConfigMap.get(sub.name);
                            const pesoNum = cfg ? Number(cfg.peso || 1) : 1;
                            const peso = Math.min(3, Math.max(1, isNaN(pesoNum) ? 1 : pesoNum));
                            const ticketsNum = cfg ? Number(cfg.tickets) : NaN;
                            const tickets = Math.max(1, isNaN(ticketsNum) ? peso : ticketsNum);
                            rows.push([catShort, sub.name, String(peso), String(tickets), '']);
                            if (Array.isArray(sub.topics)) {
                                sub.topics.forEach(t => rows.push([catShort, sub.name, String(peso), String(tickets), t]));
                            }
                        });
                    });
                }
            } else {
                const catMap = {};
                syllabusData.forEach(sec => sec.subjects.forEach(s => { catMap[s.name] = sec.category; }));
                subjectsConfig.forEach(m => {
                    const categoria = (catMap[m.name] || (m.type === 'Espec√≠fico' ? 'Conhecimentos Espec√≠ficos' : 'Conhecimentos B√°sicos'));
                    const catShort = shortCategoryLabelFromTitle(categoria);
                    rows.push([catShort, m.name, String(m.weight), String(m.tickets), '']);
                    const sec = syllabusData.find(sec => sec.subjects.some(s => s.name === m.name));
                    const subj = sec ? sec.subjects.find(s => s.name === m.name) : null;
                    if (subj && Array.isArray(subj.topics)) {
                        subj.topics.forEach(t => rows.push([catShort, m.name, String(m.weight), String(m.tickets), t]));
                    }
                });
            }
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(generalSheet), 'Gerais');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([contentHeaders, ...rows]), 'Conteudo');
            XLSX.writeFile(wb, 'modelo_ciclo_estudo_atual.xlsx');
        }

        /**
         * Abre seletor de arquivo para importar Excel.
         */
        function triggerImportModelXLSX() {
            document.getElementById('import-model-xlsx-input').click();
        }

        /**
         * Importa arquivo Excel, converte em linhas e aplica modelo.
         */
        function importModelXLSX(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    let model = null;
                    if (wb.SheetNames.includes('Gerais') && wb.SheetNames.includes('Conteudo')) {
                        const gRows = XLSX.utils.sheet_to_json(wb.Sheets['Gerais'], { header: 1 });
                        const cRows = XLSX.utils.sheet_to_json(wb.Sheets['Conteudo'], { header: 1 });
                        model = buildModelFromSheets(gRows, cRows);
                    } else {
                        const wsName = wb.SheetNames[0];
                        const ws = wb.Sheets[wsName];
                        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        model = buildModelFromCSV(rows);
                    }
                    if(!model) {
                        alert('Planilha inv√°lida. Use duas abas: Gerais e Conteudo.');
                        return;
                    }
                    applyImportedModel(model);
                    alert('Modelo Excel importado com sucesso! Cronograma regenerado.');
                } catch(err) {
                    alert('Erro ao importar Excel: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            input.value = '';
        }
        
        
        
        function resetSchedule() {
            if(confirm("Tem certeza? Isso ir√° gerar um NOVO cronograma aleat√≥rio e apagar o progresso visual do calend√°rio (hist√≥rico e syllabus ser√£o mantidos).")) {
                localStorage.removeItem('estudoFiscalScheduleStructure');
                // We should also clear status related to old schedule tasks IDs since IDs will change
                // But maybe user wants to keep completed count? 
                // Actually, if IDs change, the old status map becomes useless garbage.
                // Let's clear status map too to be clean.
                if(confirm("Deseja limpar tamb√©m o status de 'FEITO' das tarefas do calend√°rio antigo? (Recomendado)")) {
                    localStorage.removeItem('estudoFiscalData');
                }
                syncToDisk();
                location.reload();
            }
        }

        function setupOfflineFallbacks() {
            const hasXLSX = (typeof XLSX !== 'undefined');
            const btnDL = document.getElementById('btn-download-xlsx');
            const btnEX = document.getElementById('btn-export-xlsx');
            const btnIM = document.getElementById('btn-import-xlsx');
            if (btnDL && btnEX && btnIM && !hasXLSX) {
                btnDL.innerHTML = '<i class="fas fa-table"></i> Baixar Modelo CSV';
                btnDL.onclick = downloadModelTemplateCSV;
                btnEX.innerHTML = '<i class="fas fa-file-export"></i> Exportar Modelo Atual (CSV)';
                btnEX.onclick = () => alert('Use Backup JSON para exportar progresso; modelo CSV dispon√≠vel em Baixar Modelo CSV.');
                btnIM.innerHTML = '<i class="fas fa-file-import"></i> Importar Modelo CSV';
                btnIM.onclick = triggerImportModel;
                const inputX = document.getElementById('import-model-xlsx-input');
                if(inputX) inputX.style.display = 'none';
            }
        }

        function commitDraft() {
            if(!currentModalDate) return;
            const dayObj = fullSchedule.find(d => d.date.getTime() === currentModalDate.getTime());
            if(!dayObj) return;
            dayObj.tasks = JSON.parse(JSON.stringify(currentDayTasksDraft));
            dayObj.tasks.forEach(t => { const d = deriveTaskStatus(t); t.completed = (d === 'concluido'); });
            const savedData = JSON.parse(localStorage.getItem('estudoFiscalData')) || {};
            dayObj.tasks.forEach(t => {
                if(!savedData[t.id]) savedData[t.id] = {};
                const d = deriveTaskStatus(t);
                savedData[t.id].status = d;
                savedData[t.id].note = t.note;
                savedData[t.id].timeSpent = t.timeSpent || 0;
                savedData[t.id].durationTarget = t.durationTarget || 3600;
            });
            localStorage.setItem('estudoFiscalData', JSON.stringify(savedData));
            localStorage.setItem('estudoFiscalScheduleStructure', JSON.stringify(fullSchedule));
            try { fetch('/api/cycle', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ schedule: fullSchedule }) }).catch(()=>{}); } catch(e) {}
            renderCalendar();
            renderSubjects();
            renderList();
            updateStats();
            renderTimeStats();
            syncToDisk();
        }

        // Start
        function init() {
            const hasSchedule = !!localStorage.getItem('estudoFiscalScheduleStructure');
            setGenerateButtonState(hasSchedule ? 'success' : 'pending');
            // Garante reidrata√ß√£o do cronograma e aplica√ß√£o de status
            loadModelFromStorage();
            applySavedStatusToSchedule();
            renderCalendar();
            renderSubjects();
            renderList();
            updateStats();
            renderSyllabus();
            renderTimeStats();
            renderHistory();
            initCalibrationPanel();
            setupOfflineFallbacks();
        }
        
        // Hidrata dados do disco (se existirem) e ent√£o inicia a UI
        hydrateFromDisk().then(() => { init(); });


</script>
</body>
</html>
